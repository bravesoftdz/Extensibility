<?xml version="1.0"?>
<root>
  <OBJECT NAME="TERMINAL">
    <METHOD NAME="Consulta" DESCRIPTION="" VERSION="86" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="COD_PRODUTO" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Cod Produto" CTAB="0"/>
        <PARAM NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="Filial" CTAB="0"/>
        <PARAM NAME="TABELA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="Tabela" CTAB="0"/>
        <PARAM NAME="TABELA_2" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Tabela 2" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="COD_PROD" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="6" FIELDLABEL="Cod Produto" CTAB="0"/>
        <FIELD NAME="DESC_PROD" SIZE="100" FLAGS="1" PROJECTION="0" ORDER="8" FIELDLABEL="Descricao" CTAB="0"/>
        <FIELD NAME="PRECO_MEDIO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="11" FIELDLABEL="Preco Medio" CTAB="0"/>
        <FIELD NAME="CORES" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="7" FIELDLABEL="Cores" NESTEDNAME="millenium_sj.TERMINAL.CORES" CTAB="0"/>
        <FIELD NAME="TAMANHOS" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="Tamanhos" NESTEDNAME="millenium_sj.TERMINAL.TAMANHOS" CTAB="0"/>
        <FIELD NAME="ESTOQUES" FORMAT="R" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Estoques" NESTEDNAME="millenium_sj.TERMINAL.ESTOQUES" CTAB="0"/>
        <FIELD NAME="OBS_PROD" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="Obs Prod" CTAB="0"/>
        <FIELD NAME="STATUS_PROD" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="12" FIELDLABEL="Status Prod" CTAB="0"/>
        <FIELD NAME="URL_PRODUTO" SIZE="200" FLAGS="1" PROJECTION="0" ORDER="14" FIELDLABEL="Url Produto" CTAB="0"/>
        <FIELD NAME="PRECO_MEDIO2" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" FIELDLABEL="Preco Medio2" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>SELECT:P
      PRO.PRODUTO,
      PRO.COD_PRODUTO AS COD_PROD,
      PRO.DESCRICAO1 AS DESC_PROD,
      PRO.OBS AS OBS_PROD,
      PRO.URL_PRODUTO,
      SP.DESCRICAO AS STATUS_PROD,
      AVG(PRE.PRECO) AS PRECO_MEDIO,
      AVG(PRE2.PRECO) AS PRECO_MEDIO2

      #ROWSET({SELECT:CORES
                      C.COR,
                      #NULL_TO_S(C.DESCRICAO_TRADUZIDA,C.DESCRICAO) AS DESCRICAO,
                      CP.ATIVO,
                      SUM(E.SALDO)
               FROM PRODUTOS P
               INNER JOIN COR_PROD CP ON (CP.PRODUTO = P.PRODUTO)
               INNER JOIN CORES C ON (C.COR = CP.COR)
               LEFT JOIN ESTOQUES E ON (E.PRODUTO = P.PRODUTO) AND
                                       (E.COR = C.COR) AND
                                       (E.FILIAL=:FILIAL)
               WHERE
                    P.PRODUTO = :P.PRODUTO
               GROUP BY C.COR,#NULL_TO_S(C.DESCRICAO_TRADUZIDA,C.DESCRICAO),CP.ATIVO
               ORDER BY #TRANSLATE(CP.ATIVO, "A":0,"I":2,"R":1, ELSE:0), SUM(E.SALDO) DESC,#NULL_TO_S(C.DESCRICAO_TRADUZIDA,C.DESCRICAO)})

      #ROWSET({SELECT:TAMANHOS
                      T.TAMANHO,
                      SUM(E.SALDO)
               FROM PRODUTOS P
               INNER JOIN GRADES G ON (G.GRADE = P.GRADE)
               INNER JOIN TAMANHOS T ON (T.GRADE = G.GRADE)
               LEFT JOIN ESTOQUES E ON (E.PRODUTO = P.PRODUTO) AND
                                       (E.TAMANHO = T.TAMANHO) AND
                                       (E.FILIAL=:FILIAL)
               WHERE
                    P.PRODUTO = :P.PRODUTO
               GROUP BY T.TAMANHO
               ORDER BY T.CTAMANHO})

      #ROWSET({SELECT:ESTOQUES
                      #NULL_TO_S(C.DESCRICAO_TRADUZIDA,C.DESCRICAO) AS COR,
                      E.TAMANHO,
                      SUM(E.SALDO) AS ESTOQUE
               FROM ESTOQUES E
               INNER JOIN CORES C ON (C.COR = E.COR)
               WHERE
                    E.PRODUTO = :P.PRODUTO AND
                    E.FILIAL =:FILIAL
               GROUP BY #NULL_TO_S(C.DESCRICAO_TRADUZIDA,C.DESCRICAO), E.TAMANHO})

FROM PRODUTOS PRO
LEFT JOIN PRECOS PRE ON (PRO.PRODUTO = PRE.PRODUTO) AND
                        (PRE.TABELA =:TABELA)
LEFT JOIN PRECOS PRE2 ON (PRO.PRODUTO = PRE2.PRODUTO) AND
                         (PRE2.TABELA =:TABELA_2)
LEFT JOIN STATUS_PRODUTO SP ON (SP.STATUS_PRODUTO = PRO.STATUS)
WHERE
     (PRO.TIPO_PROD = 'AC') AND
     ((PRO.COD_PRODUTO =:COD_PRODUTO OR PRO.REFERENCIA LIKE :COD_PRODUTO||'%') OR
       EXISTS(SELECT 1 FROM CODIGO_BARRAS CB WHERE (CB.PRODUTO = PRO.PRODUTO) AND (CB.BARRA =:COD_PRODUTO)))
GROUP BY
         PRO.PRODUTO,
         PRO.COD_PRODUTO,
         PRO.DESCRICAO1,
         PRO.URL_PRODUTO,
         PRO.OBS,
         SP.DESCRICAO
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>