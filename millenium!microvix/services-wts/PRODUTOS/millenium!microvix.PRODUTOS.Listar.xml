<?xml version="1.0"?>
<root>
  <OBJECT NAME="PRODUTOS">
    <METHOD NAME="Listar" DESCRIPTION="Lista de Produtos" VERSION="75" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="PRODUTOS" FORMAT="R" FLAGS="1" PROJECTION="0" FIELDLABEL="Produtos" NESTEDNAME="WTSSYSTEM.INTERNALTYPES.INTEGERARRAY" CTAB="0"/>
        <PARAM NAME="UPDATE_PROD" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" FIELDLABEL="Update Prod" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="CODIGO" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="3" FIELDLABEL="C&#243;digo" CTAB="0"/>
        <FIELD NAME="NOME_PRODUTO" SIZE="60" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="Nome Produto" CTAB="0"/>
        <FIELD NAME="COD_FORNECEDOR" SIZE="60" FLAGS="1" PROJECTION="0" ORDER="5" FIELDLABEL="C&#243;digo Forncedor" CTAB="0"/>
        <FIELD NAME="REFERENCIA" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="6" FIELDLABEL="Refer&#234;ncia" CTAB="0"/>
        <FIELD NAME="COD_AUXILIAR" SIZE="40" FLAGS="1" PROJECTION="0" ORDER="7" FIELDLABEL="C&#243;digo Auxiliar" CTAB="0"/>
        <FIELD NAME="COD_BARRA" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="8" FIELDLABEL="C&#243;digo Barras" CTAB="0"/>
        <FIELD NAME="COD_SETOR" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="C&#243;digo Setor" CTAB="0"/>
        <FIELD NAME="COD_LINHA" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="C&#243;digo Linha" CTAB="0"/>
        <FIELD NAME="COD_MARCA" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="11" FIELDLABEL="C&#243;digo Marca" CTAB="0"/>
        <FIELD NAME="COD_COLECAO" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="12" FIELDLABEL="C&#243;digo Cole&#231;&#227;o" CTAB="0"/>
        <FIELD NAME="COD_ESPESSURA" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="C&#243;digo Espressura" CTAB="0"/>
        <FIELD NAME="COD_CLASSIFICACAO" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="14" FIELDLABEL="C&#243;digo Classifica&#231;&#227;o" CTAB="0"/>
        <FIELD NAME="COD_GRADE1" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="15" FIELDLABEL="C&#243;digo Grade" CTAB="0"/>
        <FIELD NAME="COD_GRUPO2" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="16" FIELDLABEL="C&#243;digo Grade Cor" CTAB="0"/>
        <FIELD NAME="UNIDADE" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="17" FIELDLABEL="Unidade" CTAB="0"/>
        <FIELD NAME="ORIGEM_MERCADORIA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="18" FIELDLABEL="Origem Mercadoria" CTAB="0"/>
        <FIELD NAME="CEST" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="19" FIELDLABEL="Cest" CTAB="0"/>
        <FIELD NAME="NCM" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="20" FIELDLABEL="Ncm" CTAB="0"/>
        <FIELD NAME="FT_INSERT" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="21" FIELDLABEL="Ft Insert" CTAB="0"/>
        <FIELD NAME="PRECO_CUSTO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="22" FIELDLABEL="Pre&#231;o Custo" CTAB="0"/>
        <FIELD NAME="PRECO_VENDA" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="23" FIELDLABEL="Pre&#231;o Venda" CTAB="0"/>
        <FIELD NAME="PRODUTO" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Produto" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#SET(TBL,${#CREATETABLE(PRODUTO INT)});

CREATE INDEX #REPLACE(TBL) ON #REPLACE(TBL) (PRODUTO);

#PRIVATE()
#EACH() PRODUTOS
  INSERT INTO #REPLACE(TBL) (PRODUTO) VALUES (:PRODUTOS.ITEM);
  
#PRIVATE()
SELECT:PROD #TOP(1) 1 FROM #REPLACE(TBL);

SELECT P.PRODUTO,
       P.COD_PRODUTO||'.'||C.COD_COR||'.'||E.COD_EST||'.'||TP.TAMANHO AS CODIGO,
       P.DESCRICAO1 AS NOME_PRODUTO,
       NULL AS COD_FORNECEDOR,
       P.REFERENCIA,
       P.COD_PRODUTO AS COD_AUXILIAR,
       (SELECT FIRST 1 BARRA
        FROM CODIGO_BARRAS CB
        WHERE (CB.PRODUTO = P.PRODUTO) AND
              (CB.COR = C.COR) AND
              (CB.ESTAMPA = E.ESTAMPA) AND
              (CB.TAMANHO = TP.TAMANHO)) AS COD_BARRA,
       D.COD_DEPARTAMENTO AS COD_SETOR,
       DV.COD_DIVISAO AS COD_LINHA,
       MA.COD_MARCA AS COD_MARCA,
       CO.COD_COLECAO AS COD_COLECAO,
       SU.COD_SUBCOLECAO AS COD_ESPESSURA,
       TPO.COD_TIPO AS COD_CLASSIFICACAO,
       TP.TAMANHO AS COD_GRADE1,
       C.COD_COR AS COD_GRUPO2,
       P.UNIDADE_USO AS UNIDADE,
       P.ORIGEM_PROD AS ORIGEM_MERCADORIA,
       CEST.CODCEST AS CEST,
       CF.DESCRICAO AS NCM,
       NULL AS FT_INSERT,
       PRECO_CUSTO.PRECO AS PRECO_CUSTO,
       PRECO_VENDA.PRECO AS PRECO_VENDA
FROM PRODUTOS P
INNER JOIN MICROVIX M ON (M.MICROVIX = M.MICROVIX)
INNER JOIN COR_PROD CP ON (CP.PRODUTO = P.PRODUTO)
INNER JOIN CORES C ON (C.COR = CP.COR)
INNER JOIN ESTAMPA_PROD EP ON (EP.PRODUTO = P.PRODUTO)
INNER JOIN ESTAMPAS E ON (E.ESTAMPA = EP.ESTAMPA)
INNER JOIN TAM_PROD TP ON (TP.PRODUTO = P.PRODUTO)

#SELECT(UPDATE_PROD,TRUE:{},ELSE:{#SELECT(PROD._EOF,TRUE:{},ELSE:{INNER JOIN (SELECT DISTINCT PRODUTO FROM #REPLACE(TBL)) TMP ON (TMP.PRODUTO = P.PRODUTO)})})

LEFT JOIN PRECOS PRECO_CUSTO ON (PRECO_CUSTO.PRODUTO = P.PRODUTO) AND
                                (PRECO_CUSTO.COR = C.COR) AND
                                (PRECO_CUSTO.ESTAMPA = E.ESTAMPA) AND
                                (PRECO_CUSTO.TAMANHO = TP.TAMANHO) AND
                                (PRECO_CUSTO.TABELA = M.TABELA_CUSTO)
                                
LEFT JOIN PRECOS PRECO_VENDA ON (PRECO_VENDA.PRODUTO = P.PRODUTO) AND
                                (PRECO_VENDA.COR = C.COR) AND
                                (PRECO_VENDA.ESTAMPA = E.ESTAMPA) AND
                                (PRECO_VENDA.TAMANHO = TP.TAMANHO) AND
                                (PRECO_VENDA.TABELA = M.TABELA_VENDA)

LEFT JOIN DEPARTAMENTOS D ON (D.DEPARTAMENTO = P.DEPARTAMENTO)
LEFT JOIN DIVISOES DV ON (DV.DIVISAO = P.DIVISAO)
LEFT JOIN MARCAS MA ON (MA.MARCA = P.MARCA)
LEFT JOIN COLECOES CO ON (CO.COLECAO = P.COLECAO)
LEFT JOIN SUBCOLECOES SU ON (SU.SUBCOLECAO = P.SUBCOLECAO)
LEFT JOIN TIPOS TPO ON (TPO.TIPO = P.TIPO)
LEFT JOIN PERFIL_IMPOSTOS PI ON (PI.PERFIL_IMPOSTO = P.PERFIL_IMPOSTO)
LEFT JOIN CLASSIFICACAO_FIS CF ON (CF.CLASSIFICACAO_FIS = PI.CLASSIFICACAO_FIS)
LEFT JOIN CEST ON (CEST.CEST = CF.CEST)

#SELECT(UPDATE_PROD,TRUE:{WHERE P.DATA_ATUALIZACAO >= M.ULTIMA_ATUA_PROD},ELSE:{})


ORDER BY P.COD_PRODUTO;
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>