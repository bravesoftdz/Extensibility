<?xml version="1.0"?>
<root>
  <OBJECT NAME="LANCAMENTOS">
    <METHOD NAME="ListarTitulosAprovar" DESCRIPTION="Lista pagamentos titulos de retorno da oficina" VERSION="32" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP NAME="Envio Oficina"/>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="DATA_INICIAL" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Data Inicial" GROUPNAME="Envio Oficina" CTAB="0"/>
        <PARAM NAME="DATA_FINAL" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Data Final" GROUPNAME="Envio Oficina" CTAB="0"/>
        <PARAM NAME="PRODUTOS" FORMAT="R" FLAGS="1" STYLE="4" PROJECTION="0" ORDER="5" LOOKUP="MILLENIUM.PRODUTOS.LISTA_FILTROPOPUP" LOOKUPKEY="PRODUTOAC" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="CODIGO" FIELDLABEL="Produtos" NESTEDNAME="WTSSYSTEM.INTERNALTYPES.INTEGERARRAY" CTAB="0"/>
        <PARAM NAME="OFICINAS" FORMAT="R" FLAGS="1" STYLE="4" PROJECTION="0" ORDER="6" LOOKUP="MILLENIUM.FORNECEDORES.LISTAOFICINAS" LOOKUPKEY="FORNECEDOR" LOOKUPDISPLAY="NOME" LOOKUPCODE="COD_FORNECEDOR" FIELDLABEL="Oficinas" NESTEDNAME="WTSSYSTEM.INTERNALTYPES.INTEGERARRAY" CTAB="0"/>
        <PARAM NAME="STATUS_AUTORIZACAO" FORMAT="N" SIZE="8" FLAGS="17" DEFAULT="0" PROJECTION="0" ORDER="7" LOOKUP="list:'0','AG. AUTORIZA&#199;&#195;O';'1','AUTORIZADO';'2','N&#195;O AUTORIZADO';" FIELDLABEL="Status" CTAB="0"/>
        <PARAM NAME="ORDEM_PRODUCAO" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="N&#176; Ordem" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="LANCAMENTO" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Lancamento" CTAB="0"/>
        <FIELD NAME="DATA_EMISSAO" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Data Emiss&#227;o" CTAB="0"/>
        <FIELD NAME="N_ORDEM" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="12" FIELDLABEL="N&#176; Ordem" CTAB="0"/>
        <FIELD NAME="N_DOCUMENTO" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="11" FIELDLABEL="N&#176; T&#237;tulo" CTAB="0"/>
        <FIELD NAME="COD_PRODUTO" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="C&#243;digo" CTAB="0"/>
        <FIELD NAME="DESC_PRODUTO" SIZE="100" FLAGS="1" PROJECTION="0" ORDER="14" FIELDLABEL="Produto" CTAB="0"/>
        <FIELD NAME="DESC_FASE" SIZE="40" FLAGS="1" PROJECTION="0" ORDER="15" FIELDLABEL="Fase" CTAB="0"/>
        <FIELD NAME="NOME_OFICINA" SIZE="100" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="Oficina" CTAB="0"/>
        <FIELD NAME="QTD_RETORNADA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="16" FIELDLABEL="Qtd Retornada" CTAB="0"/>
        <FIELD NAME="CUSTO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="17" FIELDLABEL="Custo" CTAB="0"/>
        <FIELD NAME="VALOR_INICIAL" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="18" FIELDLABEL="Valor T&#237;tulo" CTAB="0"/>
        <FIELD NAME="STATUS_AUTORIZACAO" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="19" FIELDLABEL="Status" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>SELECT L.LANCAMENTO,
       L.DATA_EMISSAO,
       P.N_ORDEM,
       L.N_DOCUMENTO,
       PR.COD_PRODUTO,
       PR.DESCRICAO1 AS DESC_PRODUTO,
       F.DESCRICAO AS DESC_FASE,
       FO.NOME AS NOME_OFICINA,
       SUM(MP.QUANTIDADE) AS QTD_RETORNADA,
       AVG(MP.CUSTO) AS CUSTO,
       ABS(L.VALOR_INICIAL) AS VALOR_INICIAL,
       #TRANSLATE(L.MNR_SITUACAO_PAG, 0:'AG. AUTORIZA&#199;&#195;O', 1:'AUTORIZADO',2:'N&#195;O AUTORIZADO', ELSE:'STATUS DESCONHECIDO') AS STATUS_AUTORIZACAO
FROM LANCAMENTOS L
INNER JOIN PRODUCAO P ON (P.PRODUCAO = L.ORIGEM)
INNER JOIN MOVIMENTO_PRODUCAO MP ON (MP.PRODUCAO = P.PRODUCAO) AND (MP.FLAGOFICINA='S') AND (MP.OFICINA = L.COD) AND (L.GERADOR='O')
INNER JOIN FASES F ON (F.FASE = MP.FASEI)
INNER JOIN PRODUTOS PR ON (PR.PRODUTO = MP.PRODUTO)
INNER JOIN FORNECEDORES FO ON (FO.FORNECEDOR = L.COD)
WHERE L.TIPO_ORIGEM='P' AND
      L.EFETUADO=FALSE AND
      L.MNR_SITUACAO_PAG = :STATUS_AUTORIZACAO
      [AND P.N_ORDEM=:ORDEM_PRODUCAO]
      [AND MP.PRODUTO IN #MAKELIST(PRODUTOS,ITEM)]
      [AND L.COD IN #MAKELIST(OFICINAS,ITEM)]
GROUP BY L.LANCAMENTO,
         L.DATA_EMISSAO,
         P.N_ORDEM,
         L.N_DOCUMENTO,
         PR.COD_PRODUTO,
         PR.DESCRICAO1,
         F.DESCRICAO,
         FO.NOME,
         ABS(L.VALOR_INICIAL),
         #TRANSLATE(L.MNR_SITUACAO_PAG, 0:'AG. AUTORIZA&#199;&#195;O', 1:'AUTORIZADO',2:'N&#195;O AUTORIZADO', ELSE:'STATUS DESCONHECIDO')
ORDER BY L.DATA_EMISSAO,P.N_ORDEM
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>