CREATE OR ALTER VIEW VW_SIM_NOTA_FISCAL(
    IDENTIFICADOR_DA_NOTA,
    CODIGO_FILIAL,
    NUMERO_NOTA,
    SERIE_NOTA,
    MODELO_NOTA,
    EMAIL_CLIENTE,
    TELEFONE_CLIENTE,
    CHAVE_NFE,
    DATA_DE_EMISSAO,
    DATA_DE_SAIDA,
    CNPJ_CPF_CLIENTE,
    CPF_CNPJ_TRANSP,
    CIF_FOB,
    VALOR_FRETE,
    CONDICOES_PAGAMENTO,
    INFORMACOES_ADICIONAIS,
    INFORMACOES_COMPLEMENTARES,
    MOTIVO_CANCELAMENTO)
AS
SELECT NF.ID AS IDENTIFICADOR_DA_NOTA,
       F.COD_FILIAL AS CODIGO_FILIAL,
       NF.NUMERO_NOTA AS NUMERO_NOTA,
       NF.SERIE AS SERIE_NOTA,
       NFM.CODIGO AS MODELO_NOTA,
       CL.E_MAIL AS EMAIL_CLIENTE,
       COALESCE(EC.DDD,"")||COALESCE(EC.FONE,"") AS TELEFONE_CLIENTE,
       NF.IDNFE AS CHAVE_NFE,
       NF.DATA AS DATA_DE_EMISSAO,
       NULL AS DATA_DE_SAIDA,
       IIF(COALESCE(CL.PAIS,0)=0,TRIM(REPLACE(REPLACE(REPLACE(IIF(CL.PF_PJ = 'PF', CL.CPF, CL.CNPJ), '.', ''), '-', ''), '/', '')),9999||10||PADLEFT(CL.COD_CLIENTE,8,'0')) AS CNPJ_CPF_CLIENTE,
       TRIM(REPLACE(REPLACE(REPLACE(IIF(TR.PF_PJ = 'PF', TR.CPF, TR.CNPJ), '.', ''), '-', ''), '/', '')) AS CPF_CNPJ_TRANSP,
       MO.CIF_FOB AS CIF_FOB,
       MO.V_FRETE AS VALOR_FRETE,
       (SELECT LIST(PZ.PRAZO,'/') FROM VW_SIM_PRAZOS_PAGTO PZ WHERE PZ.CONDICOES_PGTO = MO.CONDICOES_PGTO) AS  CONDICOES_PAGAMENTO,
       NULL AS INFORMACOES_ADICIONAIS,
       NULL AS INFORMACOES_COMPLEMENTARES,
       IIF(NF.CANCELADA='T',NF.JUSTIFICATIVA,NULL) AS MOTIVO_CANCELAMENTO
FROM NF
INNER JOIN NF_MODELOS NFM ON (NFM.NF_MODELO = NF.MODELO)
INNER JOIN MOVIMENTO MO ON (MO.TIPO_OPERACAO = NF.TIPO_OPERACAO) AND
                           (MO.COD_OPERACAO = NF.COD_OPERACAO)
INNER JOIN FILIAIS F ON (F.FILIAL = NF.FILIAL)
INNER JOIN CLIENTES CL ON (CL.CLIENTE = MO.CLIENTE)
INNER JOIN ENDERECOS_CADASTRO EC ON (EC.GERADOR = CL.GERADOR) AND
                                    (EC.COD_ENDERECO = MO.COD_ENDERECO)
LEFT JOIN TRANSPORTADORAS TR ON (TR.TRANSPORTADORA = MO.TRANSPORTADORA)
WHERE MO.TIPO_OPERACAO='S' AND
      EXISTS (SELECT 1
              FROM PRODUTOS_EVENTOS PE
              WHERE PE.COD_OPERACAO = MO.COD_OPERACAO AND
                    PE.TIPO_OPERACAO = MO.TIPO_OPERACAO AND
                    PE.PEDIDO IS NOT NULL)
;