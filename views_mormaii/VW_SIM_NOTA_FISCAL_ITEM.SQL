CREATE VIEW VW_SIM_NOTA_FISCAL_ITEM (
    IDENTIFICADOR_ITEM_NOTA,
    IDENTIFICADOR_DA_NOTA,
    QUANTIDADE,
    VALOR_UNITARIO,
    VALOR_DESCONTO_UNITARIO,
    VALOR_ICMS,
    VALOR_ICMS_SUB_TRIB,
    VALOR_PIS,
    VALOR_IPI,
    VALOR_ISS,
    VALOR_COFINS,
    VALOR_SUFRAMA,
    CODIGO_CFOP,
    CODIGO_BARRAS_PRODUTO,
    SERIE_DA_NOTA_DEVOLVIDA,
    MODELO_DA_NOTA_DEVOLVIDA,
    NUMERO_DA_NOTA_DEVOLVIDA,
    IDENTIFICADOR_ITEM_PEDIDO)
AS
SELECT PE.PRODUTO_EVENTO AS IDENTIFICADOR_ITEM_NOTA,
       NF.ID AS IDENTIFICADOR_DA_NOTA,
       PE.QUANTIDADE AS QUANTIDADE,
       PE.PRECO AS VALOR_UNITARIO,
       PE.DESCONTO AS VALOR_DESCONTO_UNITARIO,
       PE.V_ICMS AS VALOR_ICMS,
       PE.V_ICMSS AS VALOR_ICMS_SUB_TRIB,
       PE.V_PIS AS VALOR_PIS,
       PE.V_IPI AS VALOR_IPI,
       PE.V_ISS AS VALOR_ISS,
       PE.V_COFINS AS VALOR_COFINS,
       NULL AS VALOR_SUFRAMA,
       CFOP.NAT_OPERACAO AS CODIGO_CFOP,
       CB.BARRA AS CODIGO_BARRAS_PRODUTO,
       NF_DEV.SERIE AS SERIE_DA_NOTA_DEVOLVIDA,
       NF_DEV.MODELO AS MODELO_DA_NOTA_DEVOLVIDA,
       NF_DEV.NOTA AS NUMERO_DA_NOTA_DEVOLVIDA,
       PV.COD_PEDIDOV AS IDENTIFICADOR_ITEM_PEDIDO
FROM PRODUTOS_EVENTOS PE
INNER JOIN CFOP ON (CFOP.CFOP = PE.CFOP)
INNER JOIN PEDIDO_VENDA PV ON (PV.PEDIDOV = PE.PEDIDO)
INNER JOIN CODIGO_BARRAS CB ON (CB.PRODUTO = PE.PRODUTO) AND
                               (CB.COR = PE.COR) AND
                               (CB.ESTAMPA = PE.ESTAMPA) AND
                               (CB.TAMANHO = PE.TAMANHO)
INNER JOIN NF ON (NF.COD_OPERACAO = PE.COD_OPERACAO) AND
                 (NF.TIPO_OPERACAO = PE.TIPO_OPERACAO)
LEFT JOIN NF NF_DEV ON (NF_DEV.COD_OPERACAO = PE.COD_OPERACAO_REF) AND
                       (NF_DEV.TIPO_OPERACAO = PE.TIPO_OPERACAO_REF) AND
                       (NF_DEV.NOTA = PE.NOTA_REF)