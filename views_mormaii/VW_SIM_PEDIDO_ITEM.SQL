CREATE OR ALTER VIEW VW_SIM_PEDIDO_ITEM(
    IDENTIFICADOR_ITEM_PEDIDO,
    IDENTIFICADOR_DO_PEDIDO,
    DATA_ENTREGA,
    QUANTIDADE,
    VALOR_DESCONTO_UNITARIO,
    QUANTIDADE_ENTREGUE,
    VALOR_UNITARIO,
    VALOR_ICMS,
    VALOR_ICMS_SUB_TRIB,
    VALOR_IPI,
    VALOR_ISS,
    VALOR_COFINS,
    MOTIVO_CANCELAMENTO,
    CODIGO_BARRAS_PRODUTO)
AS
SELECT MAX(PPV.PRODUTO_PV) AS IDENTIFICADOR_ITEM_PEDIDO,
       PPV.PEDIDOV AS IDENTIFICADOR_DO_PEDIDO,
       MAX(PPV.DATA_ENTREGA) AS DATA_ENTREGA,
       SUM(PPV.QTD_PEDIDA) AS QUANTIDADE,
       SUM(PPV.DESCONTO) AS VALOR_DESCONTO_UNITARIO,
       SUM(PPV.QTD_FATURADA) AS QUANTIDADE_ENTREGUE,
       AVG(PPV.PRECO) AS VALOR_UNITARIO,
       SUM(PPV.VALOR_ICMS) AS VALOR_ICMS,
       SUM(PPV.VALOR_ICMS_SUB_TRIB) AS VALOR_ICMS_SUB_TRIB,
       SUM(PPV.VALOR_IPI) AS VALOR_IPI,
       SUM(PPV.VALOR_ISS) AS VALOR_ISS,
       SUM(PPV.VALOR_COFINS) AS VALOR_COFINS,
       PPV.MOTIVO_CANCELAMENTO,
       CB.BARRA AS CODIGO_BARRAS_PRODUTO
FROM (SELECT PPV.PRODUTO_PV,
             PPV.PEDIDOV,
             PPV.PRODUTO,
             PPV.COR,
             PPV.ESTAMPA,
             PPV.TAMANHO,
             COALESCE(PPV.DATA_ENTREGA_ITEM,PV.DATA_ENTREGA) AS DATA_ENTREGA,
             PPV.QUANTIDADE AS QTD_PEDIDA,
             PPV.PRECO,
             0 AS DESCONTO,
             0 AS QTD_FATURADA,
             0 AS VALOR_ICMS,
             0 AS VALOR_ICMS_SUB_TRIB,
             0 AS VALOR_IPI,
             0 AS VALOR_ISS,
             0 AS VALOR_COFINS,
             0 AS QTD_CANCELADA,
             NULL AS MOTIVO_CANCELAMENTO
      FROM PRODUTO_PEDIDOV PPV
      INNER JOIN PEDIDO_VENDA PV ON (PV.PEDIDOV = PPV.PEDIDOV)
      WHERE PPV.QUANTIDADE > 0 AND
            PPV.SAIDA IS NULL
      UNION
      SELECT PPV.PRODUTO_PV,
             PPV.PEDIDOV,
             PPV.PRODUTO,
             PPV.COR,
             PPV.ESTAMPA,
             PPV.TAMANHO,
             NULL AS ENTREGA_ENTREGA,
             0 AS QTD_PEDIDA,
             0 AS PRECO,
             0 AS DESCONTO,
             PPV.ENTREGUE AS QTD_FATURADA,
             PE.V_ICMS AS VALOR_ICMS,
             PE.V_ICMSS AS VALOR_ICMS_SUB_TRIB,
             PE.V_IPI AS VALOR_IPI,
             PE.V_ISS AS VALOR_ISS,
             PE.V_COFINS AS VALOR_COFINS,
             0 AS QTD_CANCELADA,
             NULL AS MOTIVO_CANCELAMENTO
      FROM PRODUTO_PEDIDOV PPV
      INNER JOIN PRODUTOS_EVENTOS PE ON (PE.COD_OPERACAO = PPV.SAIDA) AND
                                        (PE.TIPO_OPERACAO = "S") AND
                                        (PE.PEDIDO = PPV.PEDIDOV) AND
                                        COALESCE(PE.ITEM,"") = COALESCE(PPV.ITEM,"") AND
                                        (PE.PRODUTO = PPV.PRODUTO) AND
                                        (PE.COR = PPV.COR) AND
                                        (PE.ESTAMPA = PPV.ESTAMPA) AND
                                        (PE.TAMANHO = PPV.TAMANHO)
      WHERE PPV.SAIDA IS NOT NULL
      UNION
      SELECT PPV.PRODUTO_PV,
             PPV.PEDIDOV,
             PPV.PRODUTO,
             PPV.COR,
             PPV.ESTAMPA,
             PPV.TAMANHO,
             COALESCE(PPV.DATA_ENTREGA_ITEM,PV.DATA_ENTREGA) AS DATA_ENTREGA,
             ABS(PPV.QUANTIDADE) AS QTD_PEDIDA,
             PPV.PRECO,
             0 AS DESCONTO,
             0 AS QTD_FATURADA,
             0 AS VALOR_ICMS,
             0 AS VALOR_ICMS_SUB_TRIB,
             0 AS VALOR_IPI,
             0 AS VALOR_ISS,
             0 AS VALOR_COFINS,
             ABS(PPV.QUANTIDADE) AS QTD_CANCELADA,
             OBS.OBS AS MOTIVO_CANCELAMENTO
      FROM PRODUTO_PEDIDOV PPV
      INNER JOIN PEDIDO_VENDA PV ON (PV.PEDIDOV = PPV.PEDIDOV)
      INNER JOIN OBS_CANC OBS ON (OBS.OBS_CANC = PPV.OBS_CANC)
      WHERE PPV.QUANTIDADE < 0 AND
            PPV.SAIDA IS NULL AND
            PPV.QUITA_ITEM = 'T') PPV
LEFT JOIN CODIGO_BARRAS CB ON (CB.PRODUTO = PPV.PRODUTO) AND
                              (CB.COR = PPV.COR) AND
                              (CB.ESTAMPA = PPV.ESTAMPA) AND
                              (CB.TAMANHO = PPV.TAMANHO)

GROUP BY  PPV.PEDIDOV,
          --PPV.PRODUTO_PV,
          CB.BARRA,
          PPV.MOTIVO_CANCELAMENTO
ORDER BY PPV.PEDIDOV
;