<?xml version="1.0"?>
<root>
  <OBJECT NAME="ESTOQUES">
    <METHOD NAME="Conciliacao" DESCRIPTION="Concilica&#231;&#227;o de Estoque" VERSION="41" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" ORDER="1" LOOKUP="MILLENIUM.FILIAIS.LISTA" LOOKUPKEY="FILIAL" LOOKUPDISPLAY="NOME" LOOKUPCODE="COD_FILIAL" FIELDLABEL="Filial" CTAB="0"/>
        <PARAM NAME="TABELA" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" ORDER="2" LOOKUP="MILLENIUM.TABELAS_PRECO.LISTA_TAB" LOOKUPKEY="TABELA" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="COD_TABELA" FIELDLABEL="Tabela" CTAB="0"/>
        <PARAM NAME="DATA_HORA" SIZE="14" PROJECTION="0" FIELDLABEL="Data" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="DIVISION" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="Division" CTAB="0"/>
        <FIELD NAME="WAREHOUSE" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="5" FIELDLABEL="Warehouse" CTAB="0"/>
        <FIELD NAME="INVENTORY_LOCATION" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="6" FIELDLABEL="Inventory Location" CTAB="0"/>
        <FIELD NAME="PRODUCT_NUMBER" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="7" FIELDLABEL="Product Number" CTAB="0"/>
        <FIELD NAME="PRODUCT_CLASS" SIZE="3" FLAGS="1" PROJECTION="0" ORDER="8" FIELDLABEL="Product Class" CTAB="0"/>
        <FIELD NAME="PRODUCT_MODEL" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Product Model" CTAB="0"/>
        <FIELD NAME="PRODUCT_FAMILY" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="Product Family" CTAB="0"/>
        <FIELD NAME="BRAND_NAME" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="11" FIELDLABEL="Brand Name" CTAB="0"/>
        <FIELD NAME="PRODUCT_DESCRIPTION" SIZE="150" FLAGS="1" PROJECTION="0" ORDER="12" FIELDLABEL="Product Description" CTAB="0"/>
        <FIELD NAME="SYSTEM_MAINTAINED" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="System-maintained total on-hand" CTAB="0"/>
        <FIELD NAME="WH_MIT" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="14" FIELDLABEL="WH-MIT" CTAB="0"/>
        <FIELD NAME="SO_MIT" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="15" FIELDLABEL="SO-MIT Qtys" CTAB="0"/>
        <FIELD NAME="AVG_MATERIAL_COST" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="16" FIELDLABEL="Average Material Cost" CTAB="0"/>
        <FIELD NAME="INVENTORY" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="17" FIELDLABEL="Inventory $" CTAB="0"/>
        <FIELD NAME="AVG_MAT_COST_FUNC_CUR" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="18" FIELDLABEL="Average Material Cost(Functional currency)" CTAB="0"/>
        <FIELD NAME="INVENT_TOTAL_VALUE_FUN_CUR" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="19" FIELDLABEL="Inventory Total Value(Functional currency)" CTAB="0"/>
        <FIELD NAME="AVERAGE_MATERIAL_COST_USD" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="20" FIELDLABEL="Average Material Cost(USD$)" CTAB="0"/>
        <FIELD NAME="INVENTORY_TOTAL_VALUE_USD" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="21" FIELDLABEL="Inventory Total Value(USD$)" CTAB="0"/>
        <FIELD NAME="AGE_IN_DAYS_WITHOUT" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="22" FIELDLABEL="AGE in days without any movement" CTAB="0"/>
        <FIELD NAME="LAST_USAGE_OF_PRODUCT" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="23" FIELDLABEL="Last Usage Of Product" CTAB="0"/>
        <FIELD NAME="UPC_CODE" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="24" FIELDLABEL="Upc Code" CTAB="0"/>
        <FIELD NAME="TIMESTAMP_" SIZE="14" FLAGS="1" PROJECTION="0" ORDER="25" FIELDLABEL="Timestamp" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>SELECT  F.COD_FILIAL AS DIVISION,
        LE.LOCAL AS WAREHOUSE,
        0 AS INVENTORY_LOCATION,
        P.REFERENCIA AS PRODUCT_NUMBER,
        'ACER' AS PRODUCT_CLASS,
        '' AS PRODUCT_MODEL,
        '' AS PRODUCT_FAMILY,
        '' AS BRAND_NAME,
        P.DESCRICAO1 AS PRODUCT_DESCRIPTION,
        SUM(EL.SALDO) AS SYSTEM_MAINTAINED,
        0 AS WH_MIT,
        0 AS SO_MIT,
        AVG(PRE.PRECO) AS AVERAGE_MATERIAL_COST,
        AVG(PRE.PRECO) * SUM(EL.SALDO) AS INVENTORY,
        AVG(PRE.PRECO) AS AVERAGE_MATERIAL_COST_FUNCTIONAL_CURRENCY,
        AVG(PRE.PRECO) * SUM(EL.SALDO) AS INVENTORY_TOTAL_VALUE_FUNCTIONAL_CURRENCY ,
        AVG(PRE.PRECO) AS AVERAGE_MATERIAL_COST_USD,
        AVG(PRE.PRECO) * SUM(EL.SALDO) AS INVENTORY_TOTAL_VALUE_USD,
        MAX(DATEDIFF (DAY, S.DATA_ULTIMA_VENDA,CAST('TODAY' AS DATE))) AS AGE_IN_DAYS_WITHOUT,
        MAX(S.DATA_ULTIMA_VENDA) AS LAST_USAGE_OF_PRODUCT,
        P.REFERENCIA AS UPC_CODE,
        CAST('NOW' AS DATE) AS TIMESTAMP_
FROM ESTOQUES_LOCAIS EL
INNER JOIN FILIAIS F ON (F.FILIAL = EL.FILIAL)
INNER JOIN PRODUTOS P ON (P.PRODUTO = EL.PRODUTO)
LEFT JOIN LOCAIS_ESTOQUE LE ON (LE.IDLOCAL = EL.IDLOCAL) AND
                               (LE.FILIAL = EL.FILIAL)
LEFT JOIN (SELECT PE.PRODUTO,PE.COR,PE.ESTAMPA,PE.TAMANHO,MAX(S.DATA) AS DATA_ULTIMA_VENDA FROM SAIDAS S
           INNER JOIN PRODUTOS_EVENTOS PE ON (PE.COD_OPERACAO = S.SAIDA) AND
                                             (PE.TIPO_OPERACAO = 'S')
           WHERE S.CANCELADA = 'F'
           GROUP BY PE.PRODUTO,PE.COR,PE.ESTAMPA,PE.TAMANHO) S ON (S.PRODUTO = EL.PRODUTO) AND
                                                                  (S.COR = EL.COR) AND
                                                                  (S.ESTAMPA = EL.ESTAMPA) AND
                                                                  (S.TAMANHO = EL.TAMANHO)
LEFT JOIN PRECOS PRE ON (PRE.PRODUTO = EL.PRODUTO) AND
                        (PRE.COR = EL.COR) AND
                        (PRE.ESTAMPA = EL.ESTAMPA) AND
                        (PRE.TAMANHO = EL.TAMANHO) AND
                        (PRE.TABELA=:TABELA)
WHERE EL.FILIAL=:FILIAL AND
      LE.LOCAL = 'PECAS_CONSIGNADA_ACER'
GROUP BY F.COD_FILIAL,
         P.REFERENCIA,
         P.DESCRICAO1,
         LE.LOCAL
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>