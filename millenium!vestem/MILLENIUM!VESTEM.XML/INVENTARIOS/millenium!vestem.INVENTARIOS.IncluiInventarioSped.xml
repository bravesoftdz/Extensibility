<?xml version="1.0"?>
<root>
  <OBJECT NAME="INVENTARIOS">
    <METHOD NAME="IncluiInventarioSped" DESCRIPTION="Criar invent&#225;rio para estoque com tabela de custo valorizada pelo custo m&#233;dio" VERSION="14" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Selecione a filial para gera&#231;&#227;o do invent&#225;rio com base no estoque na data. O sistema cosiderar&#225; como estoque a QUANTIDADE+EMPENHO" ORDER="3" LOOKUP="millenium.FILIAIS.Lista" LOOKUPKEY="FILIAL" LOOKUPDISPLAY="NOME" LOOKUPCODE="COD_FILIAL" FIELDLABEL="Unidade de Neg&#243;cio" CTAB="0"/>
        <PARAM NAME="DT_INI" FORMAT="D" SIZE="10" PROJECTION="0" ORDER="3" FIELDLABEL="Data Inicial" CTAB="0"/>
        <PARAM NAME="DT_FIN" FORMAT="D" SIZE="10" FLAGS="1" DEFAULT="TODAY" PROJECTION="0" HINT="Informe a data base do estoque &#224; ser considerada na gera&#231;&#227;o do invent&#225;rio" ORDER="1" FIELDLABEL="Data Final" CTAB="0"/>
        <PARAM NAME="CRIA_TABELA" FORMAT="B" SIZE="1" DEFAULT="0" PROJECTION="0" HINT="Se selecionado este campo, o sistema criar&#225; automaticamente uma tabela de custo e alimentar&#225; o custo m&#233;dio na data informada" ORDER="3" FIELDLABEL="Cria Tabela" CTAB="0"/>
        <PARAM NAME="TIPO_PROD" SIZE="2" FLAGS="1" DEFAULT="AC" PROJECTION="0" ORDER="2" LOOKUP="list:'AC','Produto Acabado';'MP','Materia Prima';" FIELDLABEL="Tipo" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>SELECT:FIL COD_FILIAL, FILIAL_DIVERGENCIA, LOCAL_DIVERGENCIA FROM FILIAIS WHERE FILIAL = :FILIAL;

SELECT:TMP #YEAR(CAST(:DT_FIN AS TIMESTAMP)) || '/' || LPAD(#MONTH(CAST(:DT_FIN AS TIMESTAMP)),2,'0')
          || ' | ' || 'INVENTARIO FECHAMENTO'|| ' | ' || #REPLACET(:TIPO_PROD) || ' | ' || #REPLACET(:FIL.COD_FILIAL)
AS DESCRICAO FROM DUAL;
SELECT:AUX INVENTARIO FROM INVENTARIOS WHERE DESCRICAO = #REPLACET(:TMP.DESCRICAO);
#SELECT(AUX._EOF: TRUE:{},
                  ELSE:{ DELETE FROM INVENTARIOS WHERE INVENTARIO = :AUX.INVENTARIO;
                         DELETE FROM PRODUTOS_INVENTARIOS WHERE INVENTARIO = :AUX.INVENTARIO; } );
#CALL:INV MILLENIUM.INVENTARIOS.INCLUI(DATA=:DT_FIN, DESCRICAO=#REPLACET(:TMP.DESCRICAO), TIPO=:TIPO_PROD, FILIAL=:FILIAL, FILIAL_DIVERGENCIA=:FIL.FILIAL_DIVERGENCIA, LOCAL_DIVERGENCIA=:FIL.LOCAL_DIVERGENCIA);
#CALL MILLENIUM!VESTEM.INVENTARIOS.INICIALIZA(INVENTARIO=:INV.INVENTARIO);

SELECT:TMP2
 #SUBSTR(#YEAR(CAST(:DT_FIN AS TIMESTAMP)),3,'2') || '/' ||
 LPAD(#MONTH(CAST(:DT_FIN AS TIMESTAMP)),2,'0')   || '/' ||
 LPAD(#DAY(CAST(:DT_FIN AS TIMESTAMP)),2,'0')   AS COD,
 //#YEAR(CAST(:DT_FIN AS TIMESTAMP))|| '/' || LPAD(#MONTH(CAST(:DT_FIN AS TIMESTAMP)),2,'0') || ' INVENTARIO '|| #REPLACET(:TIPO_PROD)|  AS DESCRICAO
 
 #YEAR(CAST(:DT_FIN AS TIMESTAMP))|| '/' || LPAD(#MONTH(CAST(:DT_FIN AS TIMESTAMP)),2,'0') || ' INVENTARIO '|| #REPLACET(:TIPO_PROD)  AS DESCRICAO
FROM DUAL;

//#select(CRIA_TABELA,true:{
//Inclui tabela do SPED
//#CALL:TAB MILLENIUM.TABELAS_PRECO.Inclui( TABCUSTO=1, COD_TPRECO=:TMP2.COD, DESCRICAO=:TMP2.DESCRICAO, TIPO=2, TIPO_TABELA=0);
//Alimenta tabela do SPED
//#CALL MILLENIUM!HOLLY.ESTOQUE.AlimentaTabelaCustoMedio(TABELA=:TAB.TABELA, DATA=:DT_FIN, LIMPAR_TABELA=1);
//},else:{});



</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>