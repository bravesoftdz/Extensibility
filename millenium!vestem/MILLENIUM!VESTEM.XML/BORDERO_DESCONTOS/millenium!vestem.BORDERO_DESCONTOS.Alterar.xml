<?xml version="1.0"?>
<root>
  <OBJECT NAME="BORDERO_DESCONTOS">
    <METHOD NAME="Alterar" DESCRIPTION="Altera Bordero" VERSION="8" INTFTYPE="2" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP STYLE="1"/>
          <GROUP NAME="Taxa Financeira"/>
          <GROUP NAME="T&#237;tulos" STYLE="1"/>
        </GROUPS>
        <PARAM NAME="BORDERO" FORMAT="+" SIZE="8" FLAGS="1048" PROJECTION="0" FIELDLABEL="Bordero" CTAB="0"/>
        <PARAM NAME="COD_BORDERO" SIZE="20" FLAGS="17" PROJECTION="0" ORDER="3" FIELDLABEL="C&#243;digo" CTAB="0"/>
        <PARAM NAME="DESCRICAO" SIZE="60" FLAGS="17" PROJECTION="0" ORDER="4" FIELDLABEL="Descricao" CTAB="0"/>
        <PARAM NAME="DATA" FORMAT="D" SIZE="10" FLAGS="17" DEFAULT="TODAY" PROJECTION="0" ORDER="2" FIELDLABEL="Data" CTAB="0"/>
        <PARAM NAME="BORDERO_LANCAMENTOS" FORMAT="R" FLAGS="1" STYLE="3" PROJECTION="0" ORDER="16" LOOKUP="BORDERO_DESCONTOS.Seleciona_Titulo" FIELDLABEL="T&#237;tulos" NESTEDNAME="millenium!vestem.BORDERO_DESCONTOS.BORDERO_LANCAMENTOS" GROUPNAME="T&#237;tulos" CTAB="0"/>
        <PARAM NAME="BANCO" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" ORDER="5" LOOKUP="millenium.BANCOS.ListaMeusBancos" LOOKUPKEY="BANCO" LOOKUPDISPLAY="NOME" LOOKUPCODE="COD_BANCO" FIELDLABEL="Banco" CTAB="0"/>
        <PARAM NAME="CARTEIRA" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" ORDER="7" LOOKUP="millenium.CARTEIRAS.Lista_Carteiras_bco" LOOKUPKEY="CARTEIRA" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="COD_CARTEIRA" FIELDLABEL="Carteira" CTAB="0"/>
        <PARAM NAME="CONTA" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" ORDER="6" LOOKUP="millenium.CONTAS.Lista_CC" LOOKUPKEY="CONTA" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="NUMERO" FIELDLABEL="Conta" CTAB="0"/>
        <PARAM NAME="ORIGEM" FORMAT="N" SIZE="8" PROJECTION="0" ORDER="9" FIELDLABEL="Nota" CTAB="0"/>
        <PARAM NAME="OBS" SIZE="60" FLAGS="1" PROJECTION="0" ORDER="11" FIELDLABEL="Observa&#231;&#227;o" CTAB="0"/>
        <PARAM NAME="COD_BANCO" SIZE="10" FLAGS="10" PROJECTION="0" FIELDLABEL="Cod Banco" CTAB="0"/>
        <PARAM NAME="CONTROLA_DESCONTADO" FORMAT="B" SIZE="1" FLAGS="10" DEFAULT="1" PROJECTION="0" FIELDLABEL="Controla Descontado" CTAB="0"/>
        <PARAM NAME="BANCO_ADIANTAMENTO" FORMAT="N" SIZE="8" FLAGS="1" VISIBILITYRULE="(CONTROLA_DESCONTADO=TRUE)" PROJECTION="0" ORDER="8" LOOKUP="millenium.BANCOS.ListaBancosAdiantamentos" LOOKUPKEY="BANCO_ADIATAMENTO" LOOKUPDISPLAY="NOME" LOOKUPCODE="COD_BANCO_ADIATAMENTO" FIELDLABEL="Banco de adiantamento" CTAB="0"/>
        <PARAM NAME="CONTA_ADIANTAMENTO" FORMAT="N" SIZE="8" FLAGS="1" VISIBILITYRULE="(CONTROLA_DESCONTADO=TRUE)" PROJECTION="0" ORDER="9" LOOKUP="millenium.CONTAS.Lista_CC_Adiantamento" LOOKUPKEY="CONTA_ADIANTAMENTO" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="NUMERO" FIELDLABEL="Conta de adiantamento" CTAB="0"/>
        <PARAM NAME="TAXA_FINANCEIRA" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="4" VISIBILITYRULE="(CONTROLA_DESCONTADO=TRUE) AND (TAXA_FINANCEIRA_VALOR='')" PROJECTION="0" ORDER="13" FIELDLABEL="Taxa Financeira (%)" GROUPNAME="Taxa Financeira" CTAB="0"/>
        <PARAM NAME="TIPO_PGTO" FORMAT="N" SIZE="8" FLAGS="1" VISIBILITYRULE="(CONTROLA_DESCONTADO=TRUE)" PROJECTION="0" ORDER="10" LOOKUP="millenium.TIPOS_PGTOS.LISTA" LOOKUPKEY="TIPO_PGTO" LOOKUPDISPLAY="DESCRICAO" FIELDLABEL="Tipo de pagamento" CTAB="0"/>
        <PARAM NAME="TAXA_FINANCEIRA_VALOR" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="4" VISIBILITYRULE="(CONTROLA_DESCONTADO=TRUE) AND (TAXA_FINANCEIRA='')" PROJECTION="0" ORDER="14" FIELDLABEL="Taxa Financeira (Valor)" GROUPNAME="Taxa Financeira" CTAB="0"/>
        <PARAM NAME="TIPO_BORDERO" FORMAT="N" SIZE="8" FLAGS="129" DEFAULT="0" PROJECTION="0" ORDER="1" LOOKUP="list:'0','CNAB - Contas &#224; Receber';'1','PAGFOR - Contas &#224; Pagar';" FIELDLABEL="Tipo Bordero" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>//SELECT((DD_VCTO_DESCONTO > 0),
//  TRUE: {CHECK("select replace(DD_VCTO_DESCONTO) AS N from bancos", N>0, "A Qtde de Dias informada para desconto refere-se a p&amp;#243;s-vencimento. Entre com valor negativo para inverter.");},
//  ELSE: {});

#private() #call:liq millenium.configuracoes.lerparam ( 'VL_LIQ_BORDERO', 'B' );

UPDATE LANCAMENTOS
SET COBRANCA=FALSE, COD_PORTADOR=NULL, GERADOR_PORTADOR=NULL,
BORDERO=NULL, CARTEIRA=NULL, TIPO_COBRANCA=NULL, CONTA_COBRANCA=NULL,
MULTA=NULL, MORA=NULL, DIAS_PROTESTO=NULL, CONTA=CONTA_ORIGEM, CONTA_ORIGEM=NULL,
FILIAL=( SELECT FILIAL FROM CONTAS WHERE CONTAS.CONTA = LANCAMENTOS.CONTA )
WHERE (LANCAMENTOS.BORDERO=:BORDERO);

SELECT:CDBCO COD_BANCO FROM BANCOS WHERE BANCO = :BANCO;

UPDATE BORDERO
SET COD_BORDERO = :COD_BORDERO,
    DESCRICAO = :DESCRICAO,
    DATA = :DATA,
    BANCO = :BANCO,
    CONTA_COBRANCA = :CONTA,
    CARTEIRA = :CARTEIRA,
    MULTA = :MULTA,
    MORA = :MORA ,
    DIAS_PROTESTO = #SELECT(CDBCO.COD_BANCO,
                                            '237':{ #SELECT(INSTRUCAO1_237,
                                                      '06':{:DIAS_PROTESTO_237},
                                                      ELSE:{0})},
                                            ELSE :{ :DIAS_PROTESTO    }),
    OBS = :OBS,
    INSTRUCAO1 = #SELECT(CDBCO.COD_BANCO,'341':{ :INSTRUCAO341   },
                                         '237':{ :INSTRUCAO1_237 },
                                         '001':{ #SELECT( INSTRUCAO2_001, '06':{ :DIAS_PROTESTO }, ELSE:{ :INSTRUCAO2_001 }) },
                                         '422':{ #SELECT( INSTRUCAO2_422, '06':{ :DIAS_PROTESTO }, ELSE:{ :INSTRUCAO2_422 }) },
                                         ELSE :{ :INSTRUCAO1     }),
    INSTRUCAO2 = #SELECT(CDBCO.COD_BANCO,'001':{ :INSTRUCAO2_001 },
                                         '422':{ :INSTRUCAO2_422 },
                                         ELSE :{ :INSTRUCAO2     }),
    TX_DESCONTO = :TX_DESCONTO,
    DD_VCTO_DESCONTO = :DD_VCTO_DESCONTO,
    BANCO_ADIANTAMENTO =:BANCO_ADIANTAMENTO,
    CONTA_ADIANTAMENTO =:CONTA_ADIANTAMENTO,
    TAXA_FINANCEIRA =:TAXA_FINANCEIRA,
    TIPO_PGTO =:TIPO_PGTO,
    TAXA_FINANCEIRA_VALOR =:TAXA_FINANCEIRA_VALOR

WHERE (BORDERO = :BORDERO);

#SELECT(TIPO_BORDERO,0:{

#EACH() BORDERO_LANCAMENTOS AS CK;
        #SELECT(CK.ACAO,NULL:{
        #CHECK("SELECT COUNT(*) AS N FROM LANCAMENTOS WHERE LANCAMENTO=:CK.LANCAMENTO AND BORDERO&lt;>:BORDERO AND COBRANCA=TRUE",
                n>0,"Titulos que j&#225; est&#227;o em cobran&#231;a precisam ter uma a&#231;&#227;o")
                },else:{SELECT LANCAMENTO FROM LANCAMENTOS WHERE LANCAMENTO=:CK.LANCAMENTO});

#EACH() BORDERO_LANCAMENTOS AS BL;
UPDATE LANCAMENTOS
   SET COBRANCA=TRUE,
       COD_PORTADOR=:BANCO,
       GERADOR_PORTADOR='B',
       BORDERO=:BORDERO,
       CARTEIRA=:CARTEIRA,
       TIPO_COBRANCA='B',
       CONTA_COBRANCA=:CONTA,
       MULTA=:MULTA,
       MORA=:MORA,
       DIAS_PROTESTO=#SELECT(CDBCO.COD_BANCO,
                                             '237':{ #SELECT(INSTRUCAO1_237,
                                                       '06':{:DIAS_PROTESTO_237},
                                                       ELSE:{0})},
                                             ELSE :{ :DIAS_PROTESTO    }),
       CONTA_ORIGEM = CONTA,
       CONTA = :CONTA,
       FILIAL = (SELECT FILIAL FROM CONTAS WHERE CONTAS.CONTA = :CONTA )
WHERE (LANCAMENTOS.LANCAMENTO=:BL.LANCAMENTO);

DELETE FROM LANCAMENTOS_COMANDO WHERE LANCAMENTOS_COMANDO.BORDERO = :BORDERO;

#EACH() BORDERO_LANCAMENTOS AS BL2;
INSERT INTO LANCAMENTOS_COMANDO(LANCAMENTO, COMANDO, AUXILIAR1_C,
AUXILIAR2_C, INSTRUCAO, AUXILIAR1_I, AUXILIAR2_I, INSTRUCAO2,
AUXILIAR1_I2, AUXILIAR2_I2, ACAO, BORDERO)
VALUES(:BL2.LANCAMENTO, :BL2.COMANDO, :BL2.AUXILIAR1_C, :BL2.AUXILIAR2_C,
:BL2.INSTRUCAO, :BL2.AUXILIAR1_I, :BL2.AUXILIAR2_I, :BL2.INSTRUCAO2,
:BL2.AUXILIAR1_I2, :BL2.AUXILIAR2_I2, :BL2.ACAO, :BORDERO)
#RETURN (LANC_COMANDO);

DELETE FROM BORDERO_LANCAMENTOS WHERE BORDERO = :BORDERO;

#EACH() BORDERO_LANCAMENTOS AS BL3;
INSERT INTO BORDERO_LANCAMENTOS(BORDERO, LANCAMENTO)
VALUES(:BORDERO, :BL3.LANCAMENTO)
#RETURN(BO_LANCAMENTO);
},else:{

#EACH() BORDERO_PAGAMENTOS AS BP;
UPDATE LANCAMENTOS
   SET COBRANCA=TRUE,
       COD_PORTADOR=:BANCO,
       GERADOR_PORTADOR='B',
       BORDERO=:BORDERO,
       CARTEIRA=:CARTEIRA,
       TIPO_COBRANCA='B',
       CONTA_COBRANCA=:CONTA,
       CONTA_ORIGEM = CONTA,
       CONTA = :CONTA,
       FILIAL = (SELECT FILIAL FROM CONTAS WHERE CONTAS.CONTA = :CONTA )
WHERE (LANCAMENTOS.LANCAMENTO=:BP.LANCAMENTO);


DELETE FROM BORDERO_LANCAMENTOS WHERE BORDERO = :BORDERO;

#EACH() BORDERO_PAGAMENTOS AS BP3;
INSERT INTO BORDERO_LANCAMENTOS(BORDERO, LANCAMENTO)
VALUES(:BORDERO, :BP3.LANCAMENTO)
#RETURN(BO_LANCAMENTO);

});


DELETE FROM DESC_LANCAMENTO
      WHERE TIPO_ORIGEM = 'D' AND
            ORIGEM = :BORDERO;

#SELECT(TX_DESCONTO,
  NULL: {},
  ELSE: { #private();
          #SELECT((TX_DESCONTO > 0),
            TRUE: { #private();
              #SELECT(liq.valor_b,
                     true:{
                          #private() #SELECT(DD_VCTO_DESCONTO,
                            9999:{},
                            ELSE:{#EACH() BORDERO_LANCAMENTOS AS BL99;
                                    DELETE FROM DESC_LANCAMENTO WHERE LANCAMENTO=:BL99.LANCAMENTO AND TIPO_ORIGEM IS NULL AND DIAS &lt;>9999;}
                                  )
                     },
                     else:{
                          #private() #SELECT(DD_VCTO_DESCONTO,
                            9999:{},
                            ELSE:{#EACH() BORDERO_LANCAMENTOS AS BL99;
                                    DELETE FROM DESC_LANCAMENTO WHERE LANCAMENTO=:BL99.LANCAMENTO AND TIPO_ORIGEM IS NULL AND DIAS &lt;>9999;}
                                  )
                     });

              #EACH() BORDERO_LANCAMENTOS AS BL4;
                #CALL millenium.BORDERO.Alterar_insDL (:BL4.LANCAMENTO,:DD_VCTO_DESCONTO,:TX_DESCONTO,:BORDERO);
            },
            ELSE: {});

        });

</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>