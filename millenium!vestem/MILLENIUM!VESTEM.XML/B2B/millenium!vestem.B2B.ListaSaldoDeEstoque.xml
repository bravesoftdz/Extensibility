<?xml version="1.0"?>
<root>
  <OBJECT NAME="B2B">
    <METHOD NAME="ListaSaldoDeEstoque" DESCRIPTION="Consulta saldo de estoque de um produto ou de v&#225;rios produtos baseados em data de atualiza&#231;&#227;o. Este m&#233;todo pode ser usado para atualizar o estoque regularmente j&#225; que retorna apenas as mudan&#231;as desde a &#250;ltima chamada." VERSION="162" INTFTYPE="5" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="PRODUTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id do produto" ORDER="16" FIELDLABEL="Produto" CTAB="0"/>
        <PARAM NAME="COR" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id da cor" ORDER="13" FIELDLABEL="Cor" CTAB="0"/>
        <PARAM NAME="ESTAMPA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id da estampa" ORDER="14" FIELDLABEL="Estampa" CTAB="0"/>
        <PARAM NAME="TAMANHO" SIZE="5" FLAGS="1" PROJECTION="0" HINT="!Id do tamanho" ORDER="17" FIELDLABEL="Tamanho" CTAB="0"/>
        <PARAM NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="17" PROJECTION="0" HINT="!Id da Filial" ORDER="15" FIELDLABEL="Filial" CTAB="0"/>
        <PARAM NAME="FILIAIS" SIZE="1000" FLAGS="1" PROJECTION="0" HINT="!Lista de filiais" ORDER="11" FIELDLABEL="Filiais" CTAB="0"/>
        <PARAM NAME="DATA_ATUALIZACAO_INICIAL" FORMAT="H" SIZE="18" FLAGS="1" PROJECTION="0" HINT="!Data e hora da &#250;ltima leitura dos saldos. A captura desta data deve ser relacionada ao &#250;ltimo registro lido e n&#227;o a hora da esta&#231;&#227;o. Como os registros s&#227;o retornados ordenados pelo campo DATA_ATUALIZACAO, basta guardar o valor do &#250;ltimo registro e repass&#225;-lo na pr&#243;xima consulta. Esse campo ser&#225; desconsiderado caso utilize trans_id, &#233; aconselhav&#233;l utilizar o trans_id" ORDER="9" FIELDLABEL="Data Atualizacao" CTAB="0"/>
        <PARAM NAME="WEB" SIZE="1" FLAGS="1" PROJECTION="0" HINT="!Status do produto na web(T = Indispon&#237;vel na WEB, F = Indispon&#237;vel na WEB, E = Excluir da WEB)" ORDER="12" FIELDLABEL="Web" CTAB="0"/>
        <PARAM NAME="DIVISAO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Somente produtos dessa divis&#227;o" ORDER="10" FIELDLABEL="Divisao" CTAB="0"/>
        <PARAM NAME="MARCA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Somente produtos dessa marca" ORDER="7" FIELDLABEL="Marca" CTAB="0"/>
        <PARAM NAME="VITRINE" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Campo correspondente o id da vitrine." ORDER="8" FIELDLABEL="Vitrine" CTAB="0"/>
        <PARAM NAME="COMPRAS" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Campo que indica que ser&#225; considerado os pedidos de compra n&#227;o efetuados." ORDER="6" FIELDLABEL="Compras" CTAB="0"/>
        <PARAM NAME="COLECOES" SIZE="200" FLAGS="1" PROJECTION="0" HINT="!Lista de cole&#231;&#245;es do produto" ORDER="5" FIELDLABEL="Colecoes" CTAB="0"/>
        <PARAM NAME="ESTOQUE_NIVEL_KIT" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Campo indica que o estoque &#233; no n&#237;vel do Kit e n&#227;o dos componentes." ORDER="4" FIELDLABEL="Estoque Nivel Kit" CTAB="0"/>
        <PARAM NAME="AGRUPAR_FILIAIS" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="Campo indica que ser&#225; agrupado por filial." ORDER="3" FIELDLABEL="Agrupar Filiais" CTAB="0"/>
        <PARAM NAME="TRANS_ID" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Campo correspondente ao trans_id para a listagem dos estoques.&lt;br> &#xA;&lt;b> &#xA;Comportamentos &#xA;&lt;/b> &#xA;&lt;br> &#xA;- Os estoques ser&#227;o listados a partir desse trans_id. Trans_id &#233; um campo num&#233;rico que indica quando um item foi alterado." ORDER="2" FIELDLABEL="Trans Id" CTAB="0"/>
        <PARAM NAME="SKUS" FORMAT="R" FLAGS="1" PROJECTION="0" HINT="Campo correspondente a lista de skus. Podem ser informados no formato &lt;b>produto_cor_estampa_tamanho&lt;/b> ou  informar apenas os ids." ORDER="1" FIELDLABEL="Skus" NESTEDNAME="WTSSYSTEM.INTERNALTYPES.STRINGARRAY" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="SKU" SIZE="255" FLAGS="1" PROJECTION="0" HINT="SKU no formato produto_cor_estampa_tamanho" ORDER="41" FIELDLABEL="Sku" CTAB="0"/>
        <FIELD NAME="SALDO" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo de estoque do produto." ORDER="48" FIELDLABEL="Saldo" CTAB="0"/>
        <FIELD NAME="EMPENHO" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo da reserva do produto (n&#227;o deve ser considerado como saldo dispon&#237;vel)" ORDER="47" FIELDLABEL="Empenho" CTAB="0"/>
        <FIELD NAME="PRODUTO" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id do produto" ORDER="45" FIELDLABEL="Produto" CTAB="0"/>
        <FIELD NAME="COR" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id da cor" ORDER="43" FIELDLABEL="Cor" CTAB="0"/>
        <FIELD NAME="ESTAMPA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Id da estampa" ORDER="44" FIELDLABEL="Estampa" CTAB="0"/>
        <FIELD NAME="TAMANHO" SIZE="5" FLAGS="1" PROJECTION="0" HINT="!C&#243;digo do tamanho" ORDER="46" FIELDLABEL="Tamanho" CTAB="0"/>
        <FIELD NAME="DATA_ATUALIZACAO" FORMAT="H" SIZE="18" FLAGS="1" PROJECTION="0" HINT="!Data de atualiza&#231;&#227;o do pre&#231;o. Como os resultados s&#227;o ordenados por este campo, basta guardar o &#250;ltimo processado para informar como par&#226;metro DATA_ATUALIZACAO_INICIAL na pr&#243;xima chamada. Esse campo ser&#225; desconsiderado caso utilize trans_id, &#233; aconselhav&#233;l utilizar o trans_id" ORDER="32" FIELDLABEL="Data Atualizacao" CTAB="0"/>
        <FIELD NAME="VITRINE_PRODUTO_SKU" SIZE="20" FLAGS="1" PROJECTION="0" HINT="!Id do SKU" ORDER="42" FIELDLABEL="Vitrine Produto Sku" CTAB="0"/>
        <FIELD NAME="RESERVA_VITRINE" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo da reserva dos pedidos vinculados a vitrine " ORDER="36" FIELDLABEL="Reserva Vitrine" CTAB="0"/>
        <FIELD NAME="RESERVA_NAOVITRINE" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo da reserva dos pedidos n&#227;o vinculados a vitrine " ORDER="35" FIELDLABEL="Reserva Naovitrine" CTAB="0"/>
        <FIELD NAME="SALDO_VITRINE" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo dos pedidos n&#227;o reservados vinculados a vitrine " ORDER="40" FIELDLABEL="Saldo Vitrine" CTAB="0"/>
        <FIELD NAME="SALDO_NAOVITRINE" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="!Saldo dos pedidos n&#227;o reservados e n&#227;o vinculados a vitrine " ORDER="39" FIELDLABEL="Saldo Naovitrine" CTAB="0"/>
        <FIELD NAME="DATA_COMPRA" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" HINT="!Data da compra do sku" ORDER="33" FIELDLABEL="Data Compra" CTAB="0"/>
        <FIELD NAME="SALDO_COMPRA" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="Saldo da compra do sku" ORDER="38" FIELDLABEL="Saldo Compra" CTAB="0"/>
        <FIELD NAME="ESTOQUE_MIN" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Estoque m&#237;nimo do sku" ORDER="34" FIELDLABEL="Estoque Min" CTAB="0"/>
        <FIELD NAME="BARRA" SIZE="40" FLAGS="1" PROJECTION="0" HINT="C&#243;digo de barras do sku" ORDER="31" FIELDLABEL="Barra" CTAB="0"/>
        <FIELD NAME="DATA_ENVIO" FORMAT="H" SIZE="18" FLAGS="1" PROJECTION="0" HINT="!Data de envio do sku" ORDER="30" FIELDLABEL="Data Envio" CTAB="0"/>
        <FIELD NAME="ID_EXTERNO" SIZE="255" FLAGS="1" PROJECTION="0" HINT="!Id Externo do sku" ORDER="29" FIELDLABEL="Id Externo" CTAB="0"/>
        <FIELD NAME="ID" SIZE="255" FLAGS="1" PROJECTION="0" HINT="!Id do sku(Ser&#225; o Id_externo se possuir valor, sen&#227;o ser&#225; o vitrine_produto_sku)" ORDER="28" FIELDLABEL="Id" CTAB="0"/>
        <FIELD NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="!Filial do sku" ORDER="25" FIELDLABEL="Filial" CTAB="0"/>
        <FIELD NAME="FILIAL_EXTERNA" SIZE="50" FLAGS="1" PROJECTION="0" HINT="!Filial externa do sku" ORDER="26" FIELDLABEL="Filial Externa" CTAB="0"/>
        <FIELD NAME="KIT" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="!Indica se o sku &#233; um kit" ORDER="27" FIELDLABEL="Kit" CTAB="0"/>
        <FIELD NAME="COMPONENTE_KIT" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" HINT="!Indica se o sku &#233; um componente de kit" ORDER="24" FIELDLABEL="Componente Kit" CTAB="0"/>
        <FIELD NAME="DESC_PRODUTO" SIZE="255" FLAGS="1" PROJECTION="0" HINT="!Descri&#231;&#227;o do produto" ORDER="49" FIELDLABEL="Desc Produto" CTAB="0"/>
        <FIELD NAME="TRANS_ID" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Trans_id" ORDER="22" FIELDLABEL="Trans Id" CTAB="0"/>
        <FIELD NAME="PERMITE_PEDIDO_SEM_ESTOQUE" SIZE="1" FLAGS="1" PROJECTION="0" HINT="!Permite a venda sem estoque" ORDER="19" FIELDLABEL="Permite Pedido Sem Estoque" CTAB="0"/>
        <FIELD NAME="SALDO_VITRINE_COM_RESERVA" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="Se a plataforma possui o conceito de reserva, deve ser utilizado esse valor como saldo" ORDER="20" FIELDLABEL="Saldo Vitrine Com Reserva" CTAB="0"/>
        <FIELD NAME="SALDO_VITRINE_SEM_RESERVA" FORMAT="N" SIZE="15" FLAGS="1" DECIMALS="7" PROJECTION="0" HINT="Se a plataforma n&#227;o possui o conceito de reserva, deve ser utilizado esse valor como saldo" ORDER="21" FIELDLABEL="Saldo Vitrine Sem Reserva" CTAB="0"/>
        <FIELD NAME="VITRINE" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" HINT="Id da vitrine" ORDER="23" FIELDLABEL="Vitrine" CTAB="0"/>
        <FIELD NAME="COD_PRODUTO" SIZE="60" FLAGS="1" PROJECTION="0" HINT="C&#243;digo do Produto" ORDER="37" FIELDLABEL="Cod Produto" CTAB="0"/>
        <FIELD NAME="COD_FILIAL" SIZE="10" FLAGS="1" PROJECTION="0" HINT="C&#243;digo da Filial" FIELDLABEL="Cod Filial" CTAB="0"/>
        <FIELD NAME="COD_COR" SIZE="10" FLAGS="1" PROJECTION="0" FIELDLABEL="Cod Cor" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#SELECT(TRANS_ID,NULL:{},
                 ELSE:{#PRIVATE()
                       SELECT:PRO FIRST 1 EE.PRODUTO
                       FROM #SELECT(VITRINE ,NULL:{ESTOQUES EE},
                                             ELSE:{VITRINE_ESTOQUE EE})
                       WHERE EE.TRANS_ID >:TRANS_ID
                             #SELECT(VITRINE ,NULL:{},
                                              ELSE:{[AND EE.VITRINE=:VITRINE]});
                       });

#SELECT(TRANS_ID,NULL:{#SET(VAL,'1');},
                 ELSE:{#SELECT(PRO._EOF,TRUE:{#SET(VAL,'0');},
                                        ELSE:{#SET(VAL,'1');})});


#SELECT(VAL,"1":{#PRIVATE()
                 #CALL MILLENIUM.COTAS.ATUALIZACOTASDIARIAS();},
           ELSE:{});

#SELECT(VAL,"1":{#PRIVATE()
                 #CALL:LIST_SKUS MILLENIUM_ECO.PRODUTOS.DECODIFICARSKUS(VITRINE=:VITRINE,SKUS=:SKUS);},
           ELSE:{});
                
#SELECT(VAL,"1":{#SELECT(LIST_SKUS._EOF,TRUE:{},ELSE:{#PRIVATE()
                                                      SELECT LIST(V.PRODUTO) AS PRODUTO FROM (SELECT:LIST_PRODS DISTINCT PRODUTO
                                                      FROM VITRINE_PRODUTOS_SKU
                                                      WHERE VITRINE=:VITRINE AND
                                                            VITRINE_PRODUTO_SKU IN #MAKELIST(LIST_SKUS.SKUS,ITEM)) V;})},
           ELSE:{});
                
#SELECT(VAL,"1":{
SELECT
       MAX(CAST(#MONTH(V.DATA_ATUALIZACAO)||"/"||#DAY(V.DATA_ATUALIZACAO)||"/"||#YEAR(V.DATA_ATUALIZACAO)||" "||#HOUR(V.DATA_ATUALIZACAO)||":"||
         #MINUTE(V.DATA_ATUALIZACAO)||":"||CAST(#MIN_NUM(#CEIL(#SECOND(V.DATA_ATUALIZACAO)),59) AS INT) AS DATE)) AS DATA_ATUALIZACAO,
       MAX(V.DATA_COMPRA) AS DATA_COMPRA,
       V.PRODUTO,V.COR,V.ESTAMPA,V.TAMANHO,V.COD_PRODUTO,SUM(V.SALDO) AS SALDO,SUM(V.EMPENHO) AS EMPENHO,
       SUM(V.RESERVA_NAOVITRINE) AS RESERVA_NAOVITRINE,
       SUM(V.RESERVA_VITRINE) AS RESERVA_VITRINE,
       SUM(V.SALDO_NAOVITRINE) AS SALDO_NAOVITRINE,
       SUM(V.SALDO_VITRINE) AS SALDO_VITRINE,
       SUM(V.SALDO_VITRINE_COM_RESERVA) AS SALDO_VITRINE_COM_RESERVA,
       SUM(V.SALDO_VITRINE_SEM_RESERVA) AS SALDO_VITRINE_SEM_RESERVA,
       MAX(V.ESTOQUE_MIN) AS ESTOQUE_MIN,
       SUM(V.SALDO_COMPRA) AS SALDO_COMPRA,
       V.PRODUTO||"_"||V.COR||"_"||V.ESTAMPA||"_"||V.TAMANHO  AS SKU,
       MIN(V.FILIAL) as FILIAL,
       MIN(F.COD_FILIAL) as COD_FILIAL,
       MIN(CR.COD_COR) AS COD_COR,
       #SELECT(VITRINE ,NULL:{},ELSE:{V.VITRINE_PRODUTO_SKU,V.DATA_ENVIO,MAX(V.ID_EXTERNO) AS ID_EXTERNO,MAX(V.ID) AS ID #SELECT(AGRUPAR_FILIAIS,true:{},else:{, V.FILIAL_EXTERNA}) ,V.COMPONENTE_KIT,})
       V.BARRA,V.KIT,V.DESC_PRODUTO,MAX(V.TRANS_ID) AS TRANS_ID,V.PERMITE_PEDIDO_SEM_ESTOQUE,#REPLACET(:VITRINE) AS VITRINE

FROM (SELECT MAX(DATA_ATUALIZACAO) AS DATA_ATUALIZACAO, CAST(NULL AS TIMESTAMP) AS DATA_COMPRA,
             EE.PRODUTO,E.COR,E.ESTAMPA,E.TAMANHO,EE.COD_PRODUTO,SUM(E.SALDO) AS SALDO,SUM(E.EMPENHO) AS EMPENHO,
             #SELECT(VITRINE ,NULL:{0},ELSE:{#IF(SUM(E.RESERVA_NAOVITRINE)&lt;0,0,SUM(E.RESERVA_NAOVITRINE))}) AS RESERVA_NAOVITRINE,
             #SELECT(VITRINE ,NULL:{0},ELSE:{SUM(E.RESERVA_VITRINE)}) AS RESERVA_VITRINE,
             #SELECT(VITRINE ,NULL:{0},ELSE:{#IF(SUM(E.SALDO_NAOVITRINE)&lt;0,0,SUM(E.SALDO_NAOVITRINE))}) AS SALDO_NAOVITRINE,
             #SELECT(VITRINE ,NULL:{0},ELSE:{SUM(E.SALDO_VITRINE)}) AS SALDO_VITRINE,
             #SELECT(VITRINE ,NULL:{0},ELSE:{(((SUM(E.SALDO) + SUM(E.RESERVA_VITRINE))-(#IF(SUM(E.SALDO_NAOVITRINE)&lt;0,0,SUM(E.SALDO_NAOVITRINE)) - #IF(SUM(E.RESERVA_NAOVITRINE)&lt;0,0,SUM(E.RESERVA_NAOVITRINE)))) - MAX(E.ESTOQUE_MIN))}) AS SALDO_VITRINE_COM_RESERVA,
             #SELECT(VITRINE ,NULL:{0},ELSE:{((SUM(E.SALDO))-(SUM(E.SALDO_VITRINE) - SUM(E.RESERVA_VITRINE))-(#IF(SUM(E.SALDO_NAOVITRINE)&lt;0,0,SUM(E.SALDO_NAOVITRINE)) - #IF(SUM(E.RESERVA_NAOVITRINE)&lt;0,0,SUM(E.RESERVA_NAOVITRINE))) - MAX(E.ESTOQUE_MIN))}) AS SALDO_VITRINE_SEM_RESERVA,
             #SELECT(VITRINE ,NULL:{0},ELSE:{MAX(E.ESTOQUE_MIN)}) AS ESTOQUE_MIN,
             0 AS SALDO_COMPRA,
             EE.PRODUTO||"_"||E.COR||"_"||E.ESTAMPA||"_"||E.TAMANHO  AS SKU,
             E.FILIAL,
             #SELECT(VITRINE ,NULL:{},ELSE:{SKU.VITRINE_PRODUTO_SKU,SKU.DATA_ENVIO,MAX(SKU.ID_EXTERNO) AS ID_EXTERNO,MAX(#NULL_TO_S(SKU.ID_EXTERNO,SKU.VITRINE_PRODUTO_SKU)) AS ID, E.FILIAL_EXTERNA,
                                           (SELECT #IF(COUNT(*)>0,TRUE,FALSE) FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU=SKU.VITRINE_PRODUTO_SKU) AS COMPONENTE_KIT,})
             (SELECT MIN(CB.BARRA) FROM CODIGO_BARRAS CB WHERE CB.PRODUTO=EE.PRODUTO AND CB.COR = E.COR AND CB.ESTAMPA = E.ESTAMPA AND CB.TAMANHO = E.TAMANHO AND CB.CLIENTE IS NULL AND CB.FORNECEDOR IS NULL AND CB.TIPO_BARRA IS NULL) AS BARRA,
             #IF((#NULL_TO_S(EE.KIT,FALSE) = TRUE) AND (#NULL_TO_S(EE.BAIXA_ESTOQUE_FICH,"")="T"),TRUE,FALSE) AS KIT, EE.DESCRICAO1 AS DESC_PRODUTO, MAX(E.TRANS_ID) AS TRANS_ID,EE.PERMITE_PEDIDO_SEM_ESTOQUE
      FROM (SELECT DISTINCT EE.PRODUTO, EE.COR, EE.ESTAMPA, EE.TAMANHO,
                   P.COD_PRODUTO, P.GRADE, P.WEB, P.KIT, P.DIVISAO, P.COLECAO, P.BAIXA_ESTOQUE_FICH, P.DESCRICAO1,
                   P.PERMITE_PEDIDO_SEM_ESTOQUE, P.PRODUTO as PROD_ALT
            FROM #SELECT(VITRINE ,NULL:{ESTOQUES EE},
                                  ELSE:{VITRINE_ESTOQUE EE})
            INNER JOIN PRODUTOS P ON P.PRODUTO = EE.PRODUTO
            WHERE 1=1
                  #SELECT(VITRINE ,NULL:{},
                                   ELSE:{[AND EE.VITRINE=:VITRINE]})
                  #SELECT(TRANS_ID,NULL:{[AND EE.DATA_ATUALIZACAO>:DATA_ATUALIZACAO_INICIAL]},
                                   ELSE:{ [AND EE.TRANS_ID >:TRANS_ID]})
                  [AND EE.PRODUTO = :PRODUTO]
                  [AND EE.FILIAL IN #REPLACE(FILIAIS)]
                  [AND EE.FILIAL=:FILIAL]
                  #SELECT(LIST_SKUS._EOF,TRUE:{},
                                         ELSE:{[AND EE.PRODUTO IN (#REPLACE(:LIST_PRODS.PRODUTO))]})
            UNION ALL
            SELECT  DISTINCT P.PRODUTO, EE.COR, EE.ESTAMPA, EE.TAMANHO,
                   P.COD_PRODUTO, P.GRADE, P.WEB, P.KIT, P.DIVISAO, P.COLECAO, P.BAIXA_ESTOQUE_FICH, P.DESCRICAO1,
                   P.PERMITE_PEDIDO_SEM_ESTOQUE, PB.PRODUTO as PROD_ALT
            FROM #SELECT(VITRINE ,NULL:{ESTOQUES EE},
                                  ELSE:{VITRINE_ESTOQUE EE})
            INNER JOIN PRODUTOS PB ON PB.PRODUTO = EE.PRODUTO AND PB.ALTERNATIVO_PRODUTO_BASE = 'T'
            INNER JOIN PRODUTOS P ON P.PRODUTO = PB.CODBASE
            WHERE 1=1
                  #SELECT(VITRINE ,NULL:{},
                                   ELSE:{[AND EE.VITRINE=:VITRINE]})
                  #SELECT(TRANS_ID,NULL:{[AND EE.DATA_ATUALIZACAO>:DATA_ATUALIZACAO_INICIAL]},
                                   ELSE:{ [AND EE.TRANS_ID >:TRANS_ID]})
                  [AND P.PRODUTO = :PRODUTO]
                  [AND EE.FILIAL IN #REPLACE(FILIAIS)]
                  [AND EE.FILIAL=:FILIAL]
                  #SELECT(LIST_SKUS._EOF,TRUE:{},
                                         ELSE:{[AND P.PRODUTO IN (#REPLACE(:LIST_PRODS.PRODUTO))]})) EE
      #SELECT(LIST_SKUS._EOF,TRUE:{#SELECT(PRODUTO,NULL:{INNER},
                                                   ELSE:{LEFT})},
                             ELSE:{LEFT})
            JOIN (SELECT [FIRST #REPLACE(:WTSSYS_LIMIT)] EE.PRODUTO, EE.COR, EE.ESTAMPA, EE.TAMANHO, EE.FILIAL, EE.DATA_ATUALIZACAO, EE.TRANS_ID, EE.SALDO, EE.EMPENHO,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.VITRINE}) AS VITRINE,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.RESERVA_NAOVITRINE}) AS RESERVA_NAOVITRINE,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.RESERVA_VITRINE}) AS RESERVA_VITRINE,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.SALDO_NAOVITRINE}) AS SALDO_NAOVITRINE,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.SALDO_VITRINE}) AS SALDO_VITRINE,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.ESTOQUE_MIN}) AS ESTOQUE_MIN,
                                  #SELECT(VITRINE, NULL:{NULL},ELSE:{EE.FILIAL_EXTERNA}) AS FILIAL_EXTERNA
                  FROM #SELECT(VITRINE ,NULL:{ESTOQUES EE},
                                        ELSE:{VITRINE_ESTOQUE EE WHERE [AND EE.VITRINE=:VITRINE]}) ) E ON EE.PRODUTO = E.PRODUTO AND EE.COR = E.COR AND EE.ESTAMPA = E.ESTAMPA AND EE.TAMANHO = E.TAMANHO
      #SELECT(VITRINE ,NULL:{},
                       ELSE:{
      #SELECT(LIST_SKUS._EOF,TRUE:{#SELECT(PRODUTO,NULL:{INNER},
                                                   ELSE:{LEFT})},
                             ELSE:{LEFT})
           JOIN VITRINE_PRODUTOS_SKU SKU ON SKU.PRODUTO = EE.PRODUTO AND SKU.COR = E.COR AND SKU.ESTAMPA = E.ESTAMPA AND SKU.TAMANHO = E.TAMANHO AND SKU.VITRINE=E.VITRINE
                            })
      WHERE 1=1
            #SELECT(VITRINE,NULL:{},
                            ELSE:{#SELECT(LIST_SKUS._EOF,TRUE:{},ELSE:{AND SKU.VITRINE_PRODUTO_SKU IN #MAKELIST(LIST_SKUS.SKUS,ITEM)})
                                  AND (EXISTS(SELECT VP.PRODUTO FROM VITRINE_PRODUTOS VP WHERE (VP.PRODUTO = SKU.PRODUTO OR VP.PRODUTO = SKU.PRODUTO_AGRUPADOR) AND VP.VITRINE = SKU.VITRINE AND #NULL_TO_S(VP.EXCLUIDO,"F") = FALSE) OR
                                       EXISTS(SELECT VPSK.VITRINE_PRODUTO_SKU FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU = SKU.VITRINE_PRODUTO_SKU AND VPSK.VITRINE = SKU.VITRINE))
            })
            [AND E.COR=:COR]
            [AND E.ESTAMPA=:ESTAMPA]
            [AND E.TAMANHO=:TAMANHO]
            [AND E.FILIAL IN #REPLACE(FILIAIS)]
            [AND P.WEB=:WEB]
            [AND P.DIVISAO=:DIVISAO]
            [AND P.MARCA=:MARCA]
            [AND P.COLECAO IN #REPLACE(COLECOES)]
            #SELECT(VITRINE,NULL:{#SELECT(FILIAL,NULL:{},ELSE:{AND E.FILIAL=:FILIAL})},
                            ELSE:{AND E.VITRINE=:VITRINE
                                  #SELECT(ESTOQUE_NIVEL_KIT,TRUE:{AND NOT EXISTS (SELECT VPSK.VITRINE_PRODUTO_SKU FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU = SKU.VITRINE_PRODUTO_SKU)},ELSE:{})
            })
      GROUP BY EE.PRODUTO,E.COR,E.ESTAMPA,E.TAMANHO,EE.COD_PRODUTO,E.FILIAL,EE.KIT,EE.BAIXA_ESTOQUE_FICH,EE.DESCRICAO1,EE.PERMITE_PEDIDO_SEM_ESTOQUE
               #SELECT(VITRINE,NULL:{},ELSE:{,SKU.VITRINE_PRODUTO_SKU,SKU.DATA_ENVIO,E.FILIAL_EXTERNA})
      #SELECT(COMPRAS,TRUE:{
      UNION ALL
      SELECT  NULL AS DATA_ATUALIZACAO, PV.DATA_ENTREGA AS DATA_COMPRA,
              PVV.PRODUTO,PVV.COR,PVV.ESTAMPA,PVV.TAMANHO, P.COD_PRODUTO, 0 AS SALDO, 0 AS EMPENHO,
              0 AS RESERVA_NAOVITRINE,
              0 AS RESERVA_VITRINE,
              0 AS SALDO_NAOVITRINE,
              0 AS SALDO_VITRINE,
              0 AS SALDO_VITRINE_COM_RESERVA,
              0 AS SALDO_VITRINE_SEM_RESERVA,
              0 AS ESTOQUE_MIN,
              SUM(#NULL_TO_Z(PVV.QUANTIDADE) - #NULL_TO_Z(PVV.ENTREGUE)) AS SALDO_COMPRA,
              PVV.PRODUTO||"_"||PVV.COR||"_"||PVV.ESTAMPA||"_"||PVV.TAMANHO  AS SKU,
              PV.FILIAL,
              #SELECT(VITRINE ,NULL:{},ELSE:{SKU.VITRINE_PRODUTO_SKU,SKU.DATA_ENVIO,MAX(SKU.ID_EXTERNO) AS ID_EXTERNO,MAX(#NULL_TO_S(SKU.ID_EXTERNO,SKU.VITRINE_PRODUTO_SKU)) AS ID, NULL AS FILIAL_EXTERNA,
                                            (SELECT #IF(COUNT(*)>0,TRUE,FALSE) FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU=SKU.VITRINE_PRODUTO_SKU) AS COMPONENTE_KIT,
              })
              (SELECT MIN(CB.BARRA) FROM CODIGO_BARRAS CB WHERE CB.PRODUTO=PVV.PRODUTO AND CB.COR = PVV.COR AND CB.ESTAMPA = PVV.ESTAMPA AND CB.TAMANHO = PVV.TAMANHO AND CB.CLIENTE IS NULL AND CB.FORNECEDOR IS NULL AND CB.TIPO_BARRA IS NULL) AS BARRA,
              #IF((#NULL_TO_S(P.KIT,FALSE) = TRUE) AND (#NULL_TO_S(P.BAIXA_ESTOQUE_FICH,"")="T"),TRUE,FALSE) AS KIT, P.DESCRICAO1 AS DESC_PRODUTO, MAX(PVV.TRANS_ID_ESTOQUE) AS TRANS_ID,P.PERMITE_PEDIDO_SEM_ESTOQUE
      FROM PEDIDOC_NAOEFETUADOS PNE
      LEFT JOIN PEDIDO_COMPRA PV ON PV.PEDIDOC = PNE.PEDIDOC
      LEFT JOIN PRODUTO_PEDIDOC PVV ON PVV.PEDIDOC = PV.PEDIDOC
      #SELECT(VITRINE ,NULL:{},ELSE:{
      LEFT JOIN VITRINE_PRODUTOS_SKU SKU ON SKU.PRODUTO = PVV.PRODUTO AND SKU.COR = PVV.COR AND SKU.ESTAMPA = PVV.ESTAMPA AND SKU.TAMANHO = PVV.TAMANHO
      LEFT JOIN VITRINE V ON V.VITRINE=SKU.VITRINE
      })
      LEFT JOIN PRODUTOS P ON PVV.PRODUTO = P.PRODUTO
      WHERE PNE.PEDIDOC=PNE.PEDIDOC
           [AND PVV.PRODUTO=:PRODUTO]
           [AND PVV.COR=:COR]
           [AND PVV.ESTAMPA=:ESTAMPA]
           [AND PVV.TAMANHO=:TAMANHO]
           [AND SKU.VITRINE=:VITRINE]
           [AND PV.FILIAL IN #REPLACE(FILIAIS)]
           [AND P.WEB=:WEB]
           [AND P.DIVISAO=:DIVISAO]
           [AND P.MARCA=:MARCA]
           [AND P.COLECAO IN #REPLACE(COLECOES)]
           #SELECT(VITRINE,NULL:{#SELECT(FILIAL,NULL:{},ELSE:{AND PV.FILIAL=:FILIAL})},
                           ELSE:{AND PV.FILIAL=V.FILIAL
                                 #SELECT(ESTOQUE_NIVEL_KIT,TRUE:{AND NOT EXISTS (SELECT VPSK.VITRINE_PRODUTO_SKU FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU = SKU.VITRINE_PRODUTO_SKU)},ELSE:{})
                                 AND (EXISTS(SELECT VP.PRODUTO FROM VITRINE_PRODUTOS VP WHERE VP.PRODUTO = SKU.PRODUTO AND VP.VITRINE = SKU.VITRINE AND #NULL_TO_S(VP.EXCLUIDO,"F") = FALSE) OR
                                       EXISTS(SELECT VPSK.VITRINE_PRODUTO_SKU FROM VITRINE_PRODUTOS_SKU_KIT VPSK WHERE VPSK.VITRINE_PRODUTO_SKU = SKU.VITRINE_PRODUTO_SKU AND VPSK.VITRINE = SKU.VITRINE))
                                 #SELECT(LIST_SKUS._EOF,TRUE:{},ELSE:{AND SKU.VITRINE_PRODUTO_SKU IN #MAKELIST(LIST_SKUS.SKUS,ITEM)})
           })
      GROUP BY PVV.PRODUTO,PVV.COR,PVV.ESTAMPA,PVV.TAMANHO,P.COD_PRODUTO, PV.DATA_ENTREGA,PV.FILIAL,P.KIT,P.BAIXA_ESTOQUE_FICH,P.DESCRICAO1,P.PERMITE_PEDIDO_SEM_ESTOQUE
               #SELECT(VITRINE,NULL:{},ELSE:{,SKU.VITRINE_PRODUTO_SKU,SKU.DATA_ENVIO})
      },ELSE:{})
      #SELECT(VITRINE,NULL:{},ELSE:{#SELECT(ESTOQUE_NIVEL_KIT,TRUE:{
      UNION ALL
      SELECT MAX(V.DATA_ATUALIZACAO) AS DATA_ATUALIZACAO, CAST(NULL AS TIMESTAMP) AS DATA_COMPRA,
             V.PRODUTO,V.COR,V.ESTAMPA,V.TAMANHO,V.COD_PRODUTO,
             MIN(V.SALDO) AS SALDO, MIN(V.EMPENHO) AS EMPENHO,MIN(V.RESERVA_VITRINE) AS RESERVA_VITRINE, MIN(V.RESERVA_NAOVITRINE) AS RESERVA_NAOVITRINE,
             MIN(V.SALDO_NAOVITRINE) AS SALDO_NAOVITRINE,MIN(V.SALDO_VITRINE) AS SALDO_VITRINE,
             MIN(V.SALDO_VITRINE_COM_RESERVA) AS SALDO_VITRINE_COM_RESERVA, MIN(V.SALDO_VITRINE_SEM_RESERVA) AS SALDO_VITRINE_SEM_RESERVA,
             MIN(V.ESTOQUE_MIN) AS ESTOQUE_MIN,0 AS SALDO_COMPRA,
             V.PRODUTO || "_" || V.COR || "_" || V.ESTAMPA || "_" || V.TAMANHO AS SKU,V.FILIAL,V.VITRINE_PRODUTO_SKU,
             MIN(V.DATA_ENVIO) AS DATA_ENVIO,V.ID_EXTERNO,V.ID,V.FILIAL_EXTERNA,
             FALSE AS COMPONENTE_KIT,V.BARRA,TRUE AS KIT, V.DESC_PRODUTO,MAX(V.TRANS_ID) AS TRANS_ID,V.PERMITE_PEDIDO_SEM_ESTOQUE
      FROM (SELECT:KIT VPS.VITRINE_PRODUTO_SKU,VPS.PRODUTO,VPS.COR,VPS.ESTAMPA,VPS.TAMANHO,P.COD_PRODUTO,VPS.DATA_ENVIO,VPS.ID_EXTERNO,
           #NULL_TO_S(VPS.ID_EXTERNO, VPS.VITRINE_PRODUTO_SKU) AS ID,
          (SELECT MIN(CB.BARRA) FROM CODIGO_BARRAS CB WHERE CB.PRODUTO=VPS.PRODUTO AND CB.COR = VPS.COR AND CB.ESTAMPA = VPS.ESTAMPA AND CB.TAMANHO = VPS.TAMANHO AND CB.CLIENTE IS NULL AND CB.FORNECEDOR IS NULL AND CB.TIPO_BARRA IS NULL) AS BARRA,
           P.DESCRICAO1 AS DESC_PRODUTO,P.PERMITE_PEDIDO_SEM_ESTOQUE,
           #DIV(VE.SALDO,VE.QUANTIDADE) AS SALDO,
           #DIV(VE.SALDO_VITRINE,VE.QUANTIDADE) AS SALDO_VITRINE,
           #DIV(VE.SALDO_NAOVITRINE,VE.QUANTIDADE) AS SALDO_NAOVITRINE,
           #DIV(VE.RESERVA_VITRINE,VE.QUANTIDADE) AS RESERVA_VITRINE,
           #DIV(VE.RESERVA_NAOVITRINE,VE.QUANTIDADE) AS RESERVA_NAOVITRINE,
           #DIV(VE.SALDO_VITRINE_COM_RESERVA,VE.QUANTIDADE) AS SALDO_VITRINE_COM_RESERVA,
           #DIV(VE.SALDO_VITRINE_SEM_RESERVA,VE.QUANTIDADE) AS SALDO_VITRINE_SEM_RESERVA,
           #DIV(VE.EMPENHO,VE.QUANTIDADE) AS EMPENHO,
           V1.FILIAL,VE.FILIAL_EXTERNA,VE.ESTOQUE_MIN,VE.DATA_ATUALIZACAO,VE.TRANS_ID
           FROM (SELECT DISTINCT VPSK1.VITRINE_PRODUTO_SKU_PAI,VE.FILIAL,VE.VITRINE FROM VITRINE_PRODUTOS_SKU_KIT VPSK1
                 INNER JOIN VITRINE_ESTOQUE VE ON VE.VITRINE_PRODUTO_SKU = VPSK1.VITRINE_PRODUTO_SKU AND VE.VITRINE = VPSK1.VITRINE
                 WHERE VE.VITRINE=:VITRINE
                       [AND VE.FILIAL IN #REPLACE(FILIAIS)]
                       #SELECT(TRANS_ID,NULL:{[AND (VE.DATA_ATUALIZACAO>:DATA_ATUALIZACAO_INICIAL)]},ELSE:{AND VE.TRANS_ID >:TRANS_ID}))V1
           INNER JOIN VITRINE_PRODUTOS_SKU VPS ON VPS.VITRINE_PRODUTO_SKU = V1.VITRINE_PRODUTO_SKU_PAI
           INNER JOIN (SELECT VPSK.VITRINE_PRODUTO_SKU_PAI, VE.PRODUTO, VE.COR, VE.ESTAMPA, VE.TAMANHO,
                              SUM(VE.SALDO) AS SALDO,
                              SUM(VE.SALDO_VITRINE) AS SALDO_VITRINE,
                              #IF(SUM(VE.SALDO_NAOVITRINE)&lt;0,0,SUM(VE.SALDO_NAOVITRINE)) AS SALDO_NAOVITRINE,
                              SUM(VE.RESERVA_VITRINE) AS RESERVA_VITRINE,
                              #IF(SUM(VE.RESERVA_NAOVITRINE)&lt;0,0,SUM(VE.RESERVA_NAOVITRINE)) AS RESERVA_NAOVITRINE,
                              (((SUM(VE.SALDO) + SUM(VE.RESERVA_VITRINE))-(#IF(SUM(VE.SALDO_NAOVITRINE)&lt;0,0,SUM(VE.SALDO_NAOVITRINE)) - #IF(SUM(VE.RESERVA_NAOVITRINE)&lt;0,0,SUM(VE.RESERVA_NAOVITRINE)))) - MAX(VE.ESTOQUE_MIN)) AS SALDO_VITRINE_COM_RESERVA,
                              ((SUM(VE.SALDO))-(SUM(VE.SALDO_VITRINE) - SUM(VE.RESERVA_VITRINE))-(#IF(SUM(VE.SALDO_NAOVITRINE)&lt;0,0,SUM(VE.SALDO_NAOVITRINE)) - #IF(SUM(VE.RESERVA_NAOVITRINE)&lt;0,0,SUM(VE.RESERVA_NAOVITRINE))) - MAX(VE.ESTOQUE_MIN)) AS SALDO_VITRINE_SEM_RESERVA,
                              SUM(VE.EMPENHO) AS EMPENHO,
                              MAX(VE.ESTOQUE_MIN) AS ESTOQUE_MIN,
                              VE.FILIAL,
                              MIN(VE.FILIAL_EXTERNA) AS FILIAL_EXTERNA,
                              MIN(VE.DATA_ATUALIZACAO) AS DATA_ATUALIZACAO,
                              MIN(VPSK.QUANTIDADE) AS QUANTIDADE,
                              MAX(VE.TRANS_ID) AS TRANS_ID
                       FROM VITRINE_PRODUTOS_SKU_KIT VPSK
                       INNER JOIN VITRINE_ESTOQUE VE ON VE.VITRINE_PRODUTO_SKU = VPSK.VITRINE_PRODUTO_SKU AND VE.VITRINE = VPSK.VITRINE 
                       WHERE VPSK.VITRINE =:VITRINE
                       GROUP BY VPSK.VITRINE_PRODUTO_SKU_PAI, VE.PRODUTO, VE.COR, VE.ESTAMPA, VE.TAMANHO,VE.FILIAL)VE ON VE.VITRINE_PRODUTO_SKU_PAI = VPS.VITRINE_PRODUTO_SKU AND VE.FILIAL=V1.FILIAL
           INNER JOIN PRODUTOS P ON P.PRODUTO = VPS.PRODUTO
           WHERE P.PRODUTO=P.PRODUTO
                 #SELECT(LIST_SKUS._EOF,TRUE:{},ELSE:{AND VPS.VITRINE_PRODUTO_SKU IN #MAKELIST(LIST_SKUS.SKUS,ITEM)})
                 [AND VPS.PRODUTO=:PRODUTO]
                 [AND VPS.COR=:COR]
                 [AND VPS.ESTAMPA=:ESTAMPA]
                 [AND VPS.TAMANHO=:TAMANHO]
                 [AND P.WEB=:WEB]
                 [AND P.DIVISAO=:DIVISAO]
                 [AND P.MARCA=:MARCA]
                 [AND P.COLECAO IN #REPLACE(COLECOES)])V
      GROUP BY V.VITRINE_PRODUTO_SKU,V.FILIAL,V.FILIAL_EXTERNA,V.PRODUTO,V.COR,V.ESTAMPA,V.TAMANHO,V.COD_PRODUTO,V.ID_EXTERNO,V.ID,V.BARRA,V.DESC_PRODUTO,V.PERMITE_PEDIDO_SEM_ESTOQUE},ELSE:{})})
)V
INNER JOIN FILIAIS F ON F.FILIAL = V.FILIAL
INNER JOIN CORES CR ON CR.COR = V.COR
GROUP BY V.PRODUTO,V.COR,V.ESTAMPA,V.TAMANHO,V.COD_PRODUTO,V.BARRA,V.KIT,V.DESC_PRODUTO,V.PERMITE_PEDIDO_SEM_ESTOQUE
         #SELECT(VITRINE,NULL:{},ELSE:{,V.VITRINE_PRODUTO_SKU,V.DATA_ENVIO,V.COMPONENTE_KIT
                 #SELECT(AGRUPAR_FILIAIS,true:{},else:{,V.FILIAL_EXTERNA})})
ORDER BY #SELECT(TRANS_ID,NULL:{1},ELSE:{V.TRANS_ID});},ELSE:{});
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>