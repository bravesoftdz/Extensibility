<?xml version="1.0"?>
<root>
  <OBJECT NAME="MOVIMENTO_FRANQUIAS">
    <METHOD NAME="AtualizarItens" DESCRIPTION="" VERSION="10" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="COD_OPERACAO" FORMAT="N" SIZE="8" FLAGS="3" PROJECTION="0" FIELDLABEL="Cod Operacao" CTAB="0"/>
        <PARAM NAME="COD_OPERACAO_REF" FORMAT="N" SIZE="8" FLAGS="3" PROJECTION="0" FIELDLABEL="Cod Operacao Ref" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#PRIVATE()
#EACH()
SELECT:DATA
 PE1.COD_OPERACAO
,PE1.PRODUTO_EVENTO
,(SELECT MAX(PE2.V_ICMS) FROM PRODUTOS_EVENTOS PE2
   WHERE PE2.TIPO_OPERACAO = 'S'
	 AND PE2.PRODUTO       = PE1.PRODUTO
	 AND PE2.COR           = PE1.COR
	 AND PE2.ESTAMPA       = PE1.ESTAMPA
	 AND PE2.TAMANHO       = PE1.TAMANHO
	 AND PE2.QUANTIDADE    = PE1.QUANTIDADE
	 AND PE2.PRECO         = PE1.PRECO
	 AND PE2.COD_OPERACAO  = :COD_OPERACAO_REF
	 AND PE2.V_ICMS >0
   )  AS V_ICMS
,(SELECT MAX(PE2.SIT_TRIB) FROM PRODUTOS_EVENTOS PE2
   WHERE PE2.TIPO_OPERACAO = 'S'
	 AND PE2.PRODUTO       = PE1.PRODUTO
	 AND PE2.COR           = PE1.COR
	 AND PE2.ESTAMPA       = PE1.ESTAMPA
	 AND PE2.TAMANHO       = PE1.TAMANHO
	 AND PE2.QUANTIDADE    = PE1.QUANTIDADE
	 AND PE2.PRECO         = PE1.PRECO
	 AND PE2.COD_OPERACAO  = E.EVL_COD_OPERACAO_REF
	 AND PE2.V_ICMS > 0
   )  AS SIT_TRIB
,PE1.QUANTIDADE*PE1.PRECO_APLICADO AS TOTAL_LIQUIDO
FROM ENTRADAS E
  INNER JOIN PRODUTOS_EVENTOS PE1 ON PE1.TIPO_OPERACAO = 'E' AND PE1.COD_OPERACAO = E.ENTRADA
WHERE E.EVENTO = 1000105
AND E.ENTRADA = :COD_OPERACAO
  AND PE1.V_ICMS IS NULL;
  

UPDATE PRODUTOS_EVENTOS PE
SET
	 PE.V_ICMSS = 0
	,PE.V_ICMS = :DATA.V_ICMS
	,PE.V_ISS = 0
	,PE.PIS = 0
	,PE.V_PIS = 0
	,PE.COFINS = 0
	,PE.V_COFINS = 0
	,PE.B_PIS = 0
	,PE.B_COFINS = 0
	,PE.DESC_SUFRAMA = 0
	,PE.BICMSUBE = 0
	,PE.ICMSSE= 0
	,PE.V_ICMSSE = 0
	,PE.B_ISS = 0
	,PE.ICMSSE_INFLUI_FIN = 'F'
	,PE.ITEM_CUPOM = 0
	,PE.BIPI_IMP = 0
	,PE.SIT_TRIB = :DATA.SIT_TRIB
	,PE.IPI_INCIDE_ICMS_IG = 'F'
	,PE.IPI_INCIDE_ICMSSUB_IG = 'F'
	,PE.TOTAL_LIQUIDO = :DATA.TOTAL_LIQUIDO
	,PE.IT_VALOR_FRETE = 0
	,PE.IT_VALOR_SEGURO = 0
	,PE.IT_DESP_ACESSORIAS = 0
	,PE.IT_VALOR_FRETEI=0
	,PE.IT_IMPOSTO_IMPORTACAO = 0
	,PE.IT_PIS_IMPORTACAO = 0
	,PE.IT_COFINS_IMPORTACAO = 0
	,PE.IT_SISCOMEX = 0
	,PE.IT_DESPESA_ADUANEIRA = 0
	,PE.ICM_ST_SN = 0
	,PE.TAXA_ICMSS = 0
	,PE.TX_RED_ICMS = 0
	,PE.V_IPI_NC = 0
	,PE.CASAS_DECIMAIS = 8
	,PE.ABAT_PIS_COFINS = 0
	,PE.CF_NCREDITA_IPI = 'T'
	,PE.CF_TRANS_SALDO_CREDOR = 'F'
	,PE.CF_NOTA_CUPOM = 'F'
	,PE.CF_ICMS = 'T'
	,CF_IPI = 'N'
	,PE.V_ICMSS_ANT = 0
	,PE.BICMSUB_ANT = 0
	,PE.ICMSS_ANT = 0
	,PE.TAXA_ICMSS_ANT = 0
	,PE.CF_RECOLHE_ICMSST_ANT = 'F'
	,PE.EXCLUI_FIN_PROD = 'F'
	,PE.INCLUIFIN_TPROD = 'T'
	,PE.CF_CST_IPI = '03'
	,PE.CF_CST_PIS = '99'
	,PE.CF_CST_COFINS = '99'
	,PE.FATOR_CONVERSAO = 1
	,PE.ABATER_ICMS_ST_CST30 = 'F'
	,PE.SOMA_DESP_AC_BPIS_BCOFINS = 'F'
	,PE.IT_VALOR_DESCONTO = 0
	,PE.IT_VALOR_CORTESIA = 0
	,PE.IT_VALOR_BRUTO = :DATA.TOTAL_LIQUIDO
	,PE.APLICA_FATOR_CONVERSAO = 'T'
	,PE.ICMS_INTERESTADUAL = 0
	,ICMS_INTER_PART = 0
	,V_FCP_UF_DEST = 0
	,V_ICMS_UF_REMET = 0
	,BIPI_NC = 0
WHERE PE.TIPO_OPERACAO = 'E'
	AND PE.PRODUTO_EVENTO = :DATA.PRODUTO_EVENTO;
</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>