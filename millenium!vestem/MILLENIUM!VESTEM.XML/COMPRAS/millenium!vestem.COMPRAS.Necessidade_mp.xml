<?xml version="1.0"?>
<root>
  <OBJECT NAME="COMPRAS">
    <METHOD NAME="Necessidade_mp" DESCRIPTION="Lista Mat&#233;rias Primas Necess&#225;rios com Base em Pr&#233;-Fase" VERSION="80" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="DATAI" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="Produ&#231;&#227;o - Data Inicio" CTAB="0"/>
        <PARAM NAME="DATAF" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Produ&#231;&#227;o - Data Final" CTAB="0"/>
        <PARAM NAME="PRODUCAO" SIZE="255" FLAGS="1" STYLE="6" PROJECTION="0" ORDER="5" LOOKUP="MILLENIUM.PRODUCAO.Lista_Pre_Fases" LOOKUPKEY="PRODUCAO" LOOKUPDISPLAY="N_ORDEM" FIELDLABEL="Produ&#231;&#227;o" CTAB="0"/>
        <PARAM NAME="COLECAO" SIZE="255" FLAGS="1" STYLE="6" PROJECTION="0" ORDER="4" LOOKUP="millenium.colecoes.lista" LOOKUPKEY="colecao" LOOKUPDISPLAY="descricao" LOOKUPCODE="codigo" FIELDLABEL="Cole&#231;&#245;es" CTAB="0"/>
        <PARAM NAME="PRODUTO" SIZE="255" FLAGS="1" STYLE="6" PROJECTION="0" ORDER="3" LOOKUP="MILLENIUM.PRODUTOS.Lista_FiltroPopup" LOOKUPKEY="PRODUTOAC" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="CODIGO" FIELDLABEL="Produto" CTAB="0"/>
        <PARAM NAME="B_NECESSIDADE" FORMAT="B" SIZE="1" FLAGS="1" PROJECTION="0" ORDER="6" FIELDLABEL="Somente necessidade" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="CODIGO" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Codigo" CTAB="0"/>
        <FIELD NAME="DESCRICAO" SIZE="40" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="Descri&#231;&#227;o" CTAB="0"/>
        <FIELD NAME="UNIDADE" SIZE="5" FLAGS="1" PROJECTION="0" ORDER="16" FIELDLABEL="Unidade" CTAB="0"/>
        <FIELD NAME="COR" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="11" FIELDLABEL="Cor" CTAB="0"/>
        <FIELD NAME="ESTAMPA" SIZE="30" PROJECTION="0" ORDER="11" FIELDLABEL="Estampa" CTAB="0"/>
        <FIELD NAME="TAMANHO" SIZE="5" FLAGS="1" PROJECTION="0" ORDER="12" FIELDLABEL="Tamanho" CTAB="0"/>
        <FIELD NAME="NECESSIDADE" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="17" FIELDLABEL="Necessidade" CTAB="0"/>
        <FIELD NAME="ESTOQUE" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="18" FIELDLABEL="Estoque" CTAB="0"/>
        <FIELD NAME="PRECO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="23" FIELDLABEL="Pre&#231;o" CTAB="0"/>
        <FIELD NAME="COMPRA" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="19" FIELDLABEL="Compra" CTAB="0"/>
        <FIELD NAME="SOBRA" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="20" FIELDLABEL="Sobra" CTAB="0"/>
        <FIELD NAME="FALTA" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="21" FIELDLABEL="Falta" CTAB="0"/>
        <FIELD NAME="GRUPO" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="14" FIELDLABEL="Grupo" CTAB="0"/>
        <FIELD NAME="TECIDO" SIZE="10" PROJECTION="0" ORDER="8" FIELDLABEL="Tecido" CTAB="0"/>
        <FIELD NAME="DESC_COLECAO" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="13" FIELDLABEL="Cole&#231;&#227;o" CTAB="0"/>
        <FIELD NAME="DESC_TIPO" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="15" FIELDLABEL="Tipo" CTAB="0"/>
        <FIELD NAME="VALOR_FALTA" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="24" FIELDLABEL="Valor Falta" CTAB="0"/>
        <FIELD NAME="DESC_FORNECEDOR" SIZE="60" FLAGS="1" PROJECTION="0" ORDER="22" FIELDLABEL="Fornecedor" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>SELECT
  G.DESCRICAO                                AS GRUPO,
  PR.COD_PRODUTO                             AS CODIGO,
  PR.DESCRICAO1                              AS DESCRICAO,
  CL.DESCRICAO                               AS DESC_COLECAO,
  F.COD_FORNECEDOR||'-'||F.NOME              AS DESC_FORNECEDOR,
  TP.DESCRICAO                               AS DESC_TIPO,
  PR.UNIDADE_USO                             AS UNIDADE,
  CR.COD_COR||'-'||CR.DESCRICAO              AS COR,
  ES.COD_EST||'-'||ES.DESCRICAO              AS ESTAMPA,
  #VIEWNAME().TAMANHO                        AS TAMANHO,
  #VIEWNAME().PRE_FASE                       AS NECESSIDADE,
  #VIEWNAME().ESTOQUE                        AS ESTOQUE,
  #VIEWNAME().PRECO                          AS PRECO,
  #VIEWNAME().COMPRA                         AS COMPRA,

  CASE WHEN ((#VIEWNAME().PRE_FASE)) > (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA)
    THEN ((#VIEWNAME().PRE_FASE) -  (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA))
  ELSE    0  END AS FALTA,

  CASE WHEN ((#VIEWNAME().PRE_FASE)) &lt; (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA)
    THEN ((#VIEWNAME().PRE_FASE) - (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA))*-1
  ELSE    0  END AS SOBRA,

  CASE WHEN ((#VIEWNAME().PRE_FASE)) > (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA)
    THEN ((#VIEWNAME().PRE_FASE) - (#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA))*#VIEWNAME().PRECO
  ELSE    0  END AS VALOR_FALTA

FROM

#VIEW(SELECT:MAIN
            PRODUTO,
            COR,
            ESTAMPA,
            TAMANHO,
            SUM(QUANTIDADE_PRE_FASE)    AS PRE_FASE,
            SUM(COMPRA)                 AS COMPRA,
            SUM(ESTOQUE)                AS ESTOQUE,
            AVG(PRECO)                  AS PRECO
FROM
(
 SELECT
        C.PRODUTO,
        UC.COR_PRODUTO              AS COR,
        UC.ESTAMPA_PRODUTO          AS ESTAMPA,
        UC.TAMANHO_PRODUTO          AS TAMANHO ,
        SUM(PE.QUANTIDADE*UC.QUANTIDADE) AS QUANTIDADE_PRE_FASE,
        0                           AS COMPRA,
        0                           AS ESTOQUE,
        0                           AS PRECO
 FROM PRODUTOS_PRODUCAO PE
    INNER JOIN PRODUCAO PR          ON PR.PRODUCAO = PE.PRODUCAO AND PR.STATUS='I'
    INNER JOIN PRODUTOS P           ON P.PRODUTO = PE.PRODUTO
    INNER JOIN FICHAS_TECNICAS FT   ON PR.FICHA_TECNICA = FT.FICHA_TECNICA AND FT.ATUAL = 'T'
    INNER JOIN COMPONENTES C        ON C.FICHA_TECNICA = FT.FICHA_TECNICA
    INNER JOIN USO_COMPONENTES UC   ON UC.COMPONENTE = C.COMPONENTE
                                    AND PE.COR = UC.COR
                                    AND PE.TAMANHO = UC.TAMANHO
                                    AND PE.ESTAMPA = UC.ESTAMPA
 WHERE PE.PRODUCAO=PE.PRODUCAO
   [AND P.PRODUTO IN #REPLACE(PRODUTO)]
   [AND P.COLECAO IN #REPLACE(COLECAO)]
   [AND PR.PRODUCAO IN #REPLACE(PRODUCAO)]
   [AND PR.DATA_INICIO>=:DATAI AND PR.DATA_INICIO&lt;=:DATAF]

GROUP BY 1,2,3,4

HAVING  SUM(PE.QUANTIDADE*UC.QUANTIDADE)>0

UNION ALL

  SELECT
    PC.PRODUTO,
    PC.COR                          AS COR,
    PC.ESTAMPA                      AS ESTAMPA,
    PC.TAMANHO                      AS TAMANHO ,
    0                               AS QUANTIDADE_PRE_FASE,
    SUM((PC.QUANTIDADE-PC.ENTREGUE)*P.FATOR_CA)  AS COMPRA,
    0                               AS ESTOQUE,
    0                               AS PRECO
  FROM PRODUTO_PEDIDOC PC
    INNER JOIN PRODUTOS P ON P.PRODUTO=PC.PRODUTO AND P.TIPO_PROD='MP'
  GROUP BY 1,2,3,4
  HAVING SUM(PC.QUANTIDADE-PC.ENTREGUE) >0

UNION ALL

  SELECT
    PC.PRODUTO,
    PC.COR                          AS COR,
    PC.ESTAMPA                      AS ESTAMPA,
    PC.TAMANHO                      AS TAMANHO ,
    0                               AS QUANTIDADE_PRE_FASE,
    0                               AS COMPRA,
    SUM(PC.SALDO)                   AS ESTOQUE,
    0                               AS PRECO
  FROM ESTOQUES PC
    INNER JOIN PRODUTOS P ON P.PRODUTO=PC.PRODUTO AND P.TIPO_PROD='MP'
  GROUP BY 1,2,3,4
  HAVING SUM(PC.SALDO)&lt;>0

UNION ALL

  SELECT
    PREC.PRODUTO,
    PREC.COR                        AS COR,
    PREC.ESTAMPA                    AS ESTAMPA,
    PREC.TAMANHO                    AS TAMANHO ,
    0                               AS QUANTIDADE_PRE_FASE,
    0                               AS COMPRA,
    0                               AS ESTOQUE,
    AVG(PREC.PRECO)                 AS PRECO
  FROM IPRECOS PREC
    INNER JOIN PRODUTOS P ON P.PRODUTO=PREC.PRODUTO AND P.TIPO_PROD='MP'
  WHERE PREC.TABELA = 5
    GROUP BY 1,2,3,4
) V

GROUP BY 1,2,3,4 HAVING SUM(QUANTIDADE_PRE_FASE)>0)

  INNER JOIN PRODUTOS    PR ON PR.PRODUTO=#VIEWNAME().PRODUTO  AND PR.TIPO_PROD='MP'
  INNER JOIN CORES       CR ON CR.COR=#VIEWNAME().COR
  INNER JOIN ESTAMPAS    ES ON ES.ESTAMPA=#VIEWNAME().ESTAMPA
  INNER JOIN GRUPOS      G  ON G.GRUPO=PR.GRUPO
  LEFT  JOIN COLECOES    CL ON CL.COLECAO = PR.COLECAO
  LEFT  JOIN TIPOS       TP ON TP.TIPO = PR.TIPO
  LEFT JOIN FORNECEDORES F ON F.FORNECEDOR = PR.FORNECEDOR
WHERE PR.PRODUTO = PR.PRODUTO
[

#SELECT(B_NECESSIDADE,
      TRUE:{AND (( #VIEWNAME().PRE_FASE )-(#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA))>0},
      FALSE:{AND(( #VIEWNAME().PRE_FASE )-(#VIEWNAME().ESTOQUE+#VIEWNAME().COMPRA))&lt;0},
      ELSE:{})
]

ORDER BY 1,2


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>