<?xml version="1.0"?>
<root>
  <OBJECT NAME="CRM_VESTEM">
    <METHOD NAME="MovimentoDetalhesItens" DESCRIPTION="Consulta itens do movimento" VERSION="194" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="GERADOR" FORMAT="N" SIZE="8" FLAGS="18" DEFAULT="1052186" PROJECTION="0" ORDER="1" FIELDLABEL="C&#243;digo de Opera&#231;&#227;o" CTAB="0"/>
        <PARAM NAME="FILIAL" FORMAT="N" SIZE="8" FLAGS="2" PROJECTION="0" FIELDLABEL="Filial" CTAB="0"/>
        <PARAM NAME="CHAMADO" FORMAT="N" SIZE="8" FLAGS="2" PROJECTION="0" FIELDLABEL="Chamado" CTAB="0"/>
        <PARAM NAME="COD_PRODUTO_REF" SIZE="15" FLAGS="1" PROJECTION="0" ORDER="1" FIELDLABEL="C&#243;digo Produto" CTAB="0"/>
        <PARAM NAME="NOTA_FISCAL" SIZE="15" FLAGS="1" PROJECTION="0" ORDER="2" FIELDLABEL="Nota" CTAB="0"/>
      </PARAMS>
      <FIELDS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <FIELD NAME="PRODUTO" FORMAT="N" SIZE="8" PROJECTION="0" ORDER="1" FIELDLABEL="Produto" CTAB="0"/>
        <FIELD NAME="DESC_PRODUTO" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="6" FIELDLABEL="Produto" CTAB="0"/>
        <FIELD NAME="TAM_PROD" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Tam Prod" CTAB="0"/>
        <FIELD NAME="TAMANHO" SIZE="30" FLAGS="1" PROJECTION="0" ORDER="9" FIELDLABEL="Tamanho" CTAB="0"/>
        <FIELD NAME="COR" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Cor" CTAB="0"/>
        <FIELD NAME="DESC_COR" SIZE="20" FLAGS="1" PROJECTION="0" ORDER="7" FIELDLABEL="Cor" CTAB="0"/>
        <FIELD NAME="PRECO" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="13" FIELDLABEL="Preco" CTAB="0"/>
        <FIELD NAME="QUANTIDADE" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="11" FIELDLABEL="Qtde Nota" CTAB="0"/>
        <FIELD NAME="COD_OPERACAO" FORMAT="N" SIZE="8" PROJECTION="0" ORDER="8" FIELDLABEL="Cod Operacao" CTAB="0"/>
        <FIELD NAME="TIPO_OPERACAO" SIZE="1" PROJECTION="0" ORDER="9" FIELDLABEL="Tipo Operacao" CTAB="0"/>
        <FIELD NAME="NOTA" SIZE="15" FLAGS="1" PROJECTION="0" ORDER="5" FIELDLABEL="Nota" CTAB="0"/>
        <FIELD NAME="BASE_ICMS" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="14" FIELDLABEL="Base Icms" CTAB="0"/>
        <FIELD NAME="ICMS" FORMAT="N" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="15" FIELDLABEL="Icms" CTAB="0"/>
        <FIELD NAME="V_ICMS" FORMAT="M" SIZE="17" FLAGS="1" DECIMALS="4" PROJECTION="0" ORDER="16" FIELDLABEL="Valor Icms" CTAB="0"/>
        <FIELD NAME="TOTAL" FORMAT="M" SIZE="17" DECIMALS="4" PROJECTION="0" ORDER="5" FIELDLABEL="Total" CTAB="0"/>
        <FIELD NAME="DATA" FORMAT="D" SIZE="10" FLAGS="1" PROJECTION="0" ORDER="4" FIELDLABEL="Data" CTAB="0"/>
        <FIELD NAME="ESTAMPA" FORMAT="N" SIZE="8" FLAGS="1" PROJECTION="0" ORDER="8" FIELDLABEL="Estampa" CTAB="0"/>
        <FIELD NAME="EVL_SIT_TRIB" SIZE="3" FLAGS="1" PROJECTION="0" ORDER="10" FIELDLABEL="CST" CTAB="0"/>
        <FIELD NAME="EVL_QUANTIDADE" FORMAT="N" SIZE="8" FLAGS="1" DECIMALS="2" PROJECTION="0" ORDER="12" FIELDLABEL="Qtd Devolvida" CTAB="0"/>
        <FIELD NAME="SELECIONADO" FORMAT="B" SIZE="1" PROJECTION="0" ORDER="4" FIELDLABEL="Selecionado" CTAB="0"/>
        <FIELD NAME="OBSERVACAO" SIZE="3000" FLAGS="1" PROJECTION="0" ORDER="17" FIELDLABEL="Obs" CTAB="0"/>
      </FIELDS>
      <ACTIONSCRIPT>#SELECT(CHAMADO
  ,NULL:{

  #PRIVATE()
  #SET(TBM,
    ${#CREATETABLE(
       COD_OPERACAO INT,
       TIPO_OPERACAO VARCHAR(1),
       GERADOR INT,
       PRODUTO INT,
       COR INT,
       ESTAMPA INT,
       TAMANHO VARCHAR(5),
       QUANTIDADE DOUBLE PRECISION,
       PRECO DOUBLE PRECISION,
       BASE_ICMS DOUBLE PRECISION,
       ICMS DOUBLE PRECISION,
       V_ICMS DOUBLE PRECISION
    )
   }
  );

//#PRIVATE()
//  CREATE INDEX #REPLACE(TBM)_1 ON #REPLACE(TBM) (COD_OPERACAO,TIPO_OPERACAO,GERADOR,PRODUTO,COR,ESTAMPA,TAMANHO);

#PRIVATE()
  INSERT INTO #REPLACE(TBM)

SELECT
  PE.COD_OPERACAO,
  PE.TIPO_OPERACAO,
  M.GERADOR,
  PE.PRODUTO,
  PE.COR,
  PE.ESTAMPA,
  PE.TAMANHO,
  SUM(COALESCE(PE.QUANTIDADE,0))                 AS QUANTIDADE,
  AVG(COALESCE(PE.PRECO_TOTAL,0))                AS PRECO,
  SUM(COALESCE(PE.BICM,0))                       AS BASE_ICMS,
  AVG(COALESCE(PE.ICM,0))                        AS ICMS,
  SUM(COALESCE(PE.V_ICMS,0))                     AS V_ICMS
FROM PRODUTOS_EVENTOS PE
  INNER JOIN MOVIMENTO M ON M.COD_OPERACAO = PE.COD_OPERACAO AND PE.TIPO_OPERACAO = M.TIPO_OPERACAO
  INNER JOIN PRODUTOS P ON P.PRODUTO = PE.PRODUTO
WHERE M.CANCELADA = 'F'
  AND M.GERADOR = :GERADOR
 [AND M.FILIAL  = :FILIAL]
 [AND P.COD_PRODUTO = :COD_PRODUTO_REF]
  AND PE.TIPO_OPERACAO = "S"
  AND PE.QUANTIDADE &lt;> 0

GROUP BY 1,2,3,4,5,6,7

UNION ALL

SELECT
  PE.COD_OPERACAO_REF                            AS COD_OPERACAO,
  PE.TIPO_OPERACAO_REF                           AS TIPO_OPERACAO,
  M.GERADOR,
  PE.PRODUTO,
  PE.COR,
  PE.ESTAMPA,
  PE.TAMANHO,
  SUM(COALESCE(PE.QUANTIDADE*-1,0))              AS QUANTIDADE,
  AVG(COALESCE(PE.PRECO_TOTAL,0))                AS PRECO,
  SUM(COALESCE(PE.BICM*-1,0))                    AS BASE_ICMS,
  AVG(COALESCE(PE.ICM*-1,0))                     AS ICMS,
  SUM(COALESCE(PE.V_ICMS*-1,0))                  AS V_ICMS
FROM PRODUTOS_EVENTOS     PE
  INNER JOIN MOVIMENTO M ON M.COD_OPERACAO = PE.COD_OPERACAO AND PE.TIPO_OPERACAO = M.TIPO_OPERACAO
  INNER JOIN PRODUTOS P ON P.PRODUTO = PE.PRODUTO
WHERE M.CANCELADA = 'F'
  AND M.GERADOR = :GERADOR
 [AND M.FILIAL  = :FILIAL]
 [AND P.COD_PRODUTO = :COD_PRODUTO_REF]
  AND PE.TIPO_OPERACAO = "E"
  AND PE.QUANTIDADE &lt;> 0

GROUP BY 1,2,3,4,5,6,7;

SELECT:MAIN
  TRUE AS SELECIONADO,
  TMP.COD_OPERACAO,
  TMP.TIPO_OPERACAO,
  TMP.GERADOR,
  TMP.PRODUTO,
  TMP.COR,
  TMP.ESTAMPA,
  TMP.TAMANHO,
  (SELECT FIRST 1(PE2.sit_trib)
    FROM PRODUTOS_EVENTOS PE2
  WHERE PE2.COD_OPERACAO  = TMP.COD_OPERACAO
    AND PE2.TIPO_OPERACAO = TMP.TIPO_OPERACAO
    AND PE2.PRODUTO       = TMP.PRODUTO
    AND PE2.COR           = TMP.COR
    AND PE2.ESTAMPA       = TMP.ESTAMPA
    AND PE2.TAMANHO       = TMP.TAMANHO)        AS EVL_SIT_TRIB,
  MIN(P.COD_PRODUTO)||' - '||MIN(P.DESCRICAO1)  AS DESC_PRODUTO,
  MIN(CR.COD_COR)||' - '||MIN(CR.DESCRICAO)     AS DESC_COR,
  MIN(N.NUMERO_NOTA)                            AS NOTA,
  MIN(N.DATA)                                   AS DATA,
  SUM(TMP.QUANTIDADE)                           AS QUANTIDADE,
  SUM(TMP.QUANTIDADE)                           AS EVL_QUANTIDADE,
  SUM(TMP.QUANTIDADE*TMP.PRECO)                 AS TOTAL,
  AVG(TMP.PRECO)                                AS PRECO,
  SUM(TMP.BASE_ICMS/TMP.QUANTIDADE)             AS BASE_ICMS,
  AVG(TMP.ICMS)                                 AS ICMS,
  SUM(TMP.V_ICMS/TMP.QUANTIDADE)                AS V_ICMS
FROM MOVIMENTO M
  INNER JOIN NF            N   ON  N.COD_OPERACAO    = M.COD_OPERACAO AND N.TIPO_OPERACAO = M.TIPO_OPERACAO
  INNER JOIN #REPLACE(TBM) TMP ON  TMP.COD_OPERACAO  = M.COD_OPERACAO
                               AND TMP.TIPO_OPERACAO = M.TIPO_OPERACAO
                               AND TMP.GERADOR       = M.GERADOR
  INNER JOIN PRODUTOS      P  ON   P.PRODUTO  = TMP.PRODUTO
  INNER JOIN COR_PROD     CP  ON   CP.PRODUTO = P.PRODUTO
  INNER JOIN CORES        CR  ON   CR.COR     = CP.COR
  
  WHERE M.COD_OPERACAO = M.COD_OPERACAO
  [AND N.NUMERO_NOTA   = :NOTA_FISCAL]

GROUP BY 1,2,3,4,5,6,7,8

HAVING SUM(TMP.QUANTIDADE)>0

ORDER BY 1 DESC

  },
  ELSE:{
      SELECT
        TMP.SELECIONADO,
        TMP.PRODUTO,
        TMP.COR,
        TMP.ESTAMPA,
        TMP.TAMANHO,
        TMP.LOTE,
        TMP.DEFEITO,
        TMP.OBSERVACAO,
        TMP.PRECO,
        TMP.QUANTIDADE,
        TMP.EVL_QUANTIDADE,
        TMP.NOTA,
        //TMP.EVL_TOTAL,
        TMP.ICMS,
        TMP.DESC_PRODUTO,
        TMP.DESC_COR,
        TMP.DATA,
        TMP.EVL_SIT_TRIB,
        TMP.BASE_ICMS,
        TMP.V_ICMS,
        TMP.DESC_PRODUTO,
        TMP.DESC_COR,
        TMP.CORTESIA_UNITARIO,
        TMP.ACERTO_UNITARIO,
        TMP.FRETE_UNITARIO
      FROM (
      SELECT
        TRUE AS SELECIONADO,
        CPC.PRODUTO,
        CPC.COR,
        CPC.ESTAMPA,
        CPC.TAMANHO,
        CPC.LOTE,
        CPC.DEFEITO,
        CPC.OBSERVACAO,
        CPC.PRECO,
        CPC.QUANTIDADE                          AS QUANTIDADE,
        CPC.QUANTIDADE                          AS EVL_QUANTIDADE,
        CPC.EVL_NOTA                            AS NOTA,
        CPC.EVL_TOTAL,
        CPC.EVL_ICMS                            AS ICMS,
        CPC.EVL_DATA                            AS DATA,
        CPC.EVL_SIT_TRIB,
        (CPC.EVL_BASE_ICMS / CPC.QUANTIDADE)    AS BASE_ICMS,
        (CPC.EVL_V_ICMS / CPC.QUANTIDADE)       AS V_ICMS,

        (P.COD_PRODUTO)||' - '||(P.DESCRICAO1)  AS DESC_PRODUTO,
        (CR.COD_COR)||' - '||(CR.DESCRICAO)     AS DESC_COR,
        (CPC.VALOR_CORTESIA / CPC.QUANTIDADE)   AS CORTESIA_UNITARIO,
        (CPC.VALOR_ACERTO / CPC.QUANTIDADE)     AS ACERTO_UNITARIO,
        (CPC.VALOR_FRETE / CPC.QUANTIDADE)      AS FRETE_UNITARIO
      FROM CHAMADO_PRODUTOS_CRM CPC
        INNER JOIN PRODUTOS       P  ON   P.PRODUTO  = CPC.PRODUTO
        INNER JOIN CORES         CR  ON   CR.COR     = CPC.COR
      WHERE CHAMADO =:CHAMADO
      ) TMP
  }
);


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>