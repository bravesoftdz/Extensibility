<?xml version="1.0"?>
<root>
  <OBJECT NAME="CRM_VESTEM">
    <METHOD NAME="Inclui" DESCRIPTION="Incluir - Protocolo" VERSION="31" INTFTYPE="1" TRIGGEROF="XRM.CHAMADOS.Inclui" TRIGGERTYPE="1" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
          <GROUP NAME="Notas Fiscais de Origem" STYLE="1"/>
          <GROUP NAME="Origem"/>
        </GROUPS>
        <PARAM NAME="NOTA" FORMAT="N" SIZE="8" SOURCEEXPRESSION="CRM_VESTEM.CRM_VESTEM.NOTA" PROJECTION="0" ORDER="1" FIELDLABEL="Nota" GROUPNAME="Origem" CTAB="0"/>
        <PARAM NAME="ITENS_MOVIMENTO" FORMAT="R" FLAGS="1" STYLE="3" PROJECTION="0" ORDER="3" LOOKUP="CRM_VESTEM.MovimentoDetalhesItens" FIELDLABEL="Produtos" NESTEDNAME="millenium!vestem.CRM_VESTEM.ITENS_MOVIMENTO" GROUPNAME="Notas Fiscais de Origem" CTAB="0"/>
        <PARAM NAME="TROCA_DEVOLUCAO" FORMAT="N" SIZE="8" DEFAULT="0" PROJECTION="0" FIELDLABEL="Troca Devolucao" CTAB="0"/>
        <PARAM NAME="PEDIDOV" FORMAT="N" SIZE="8" DEFAULT="0" PROJECTION="0" FIELDLABEL="Pedidov" CTAB="0"/>
        <PARAM NAME="NOTA_PRESENTE" FORMAT="B" SIZE="1" PROJECTION="0" FIELDLABEL="Nota Presente" CTAB="0"/>
        <PARAM NAME="COD_OPERACAO_NF" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Cod Operacao Nf" CTAB="0"/>
        <PARAM NAME="TIPO_OPERACAO_NF" SIZE="1" PROJECTION="0" FIELDLABEL="Tipo Operacao Nf" CTAB="0"/>
        <PARAM NAME="CLIENTE_CONTATADO" FORMAT="B" SIZE="1" FLAGS="17" DEFAULT="0" PROJECTION="0" ORDER="1" FIELDLABEL="Cliente Contatado" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>SELECT CHAMADO FROM CHAMADOS WHERE CHAMADO=:WTSSYS_OBJECT;

//#SELECT(RELACIONAR,1:{#SELECT(PEDIDOV,NULL:{#CHECK("SELECT 1 AS N FROM DUAL",N>0,"Tipo de chamado selecionado, requer que seja informado o pedido de venda");},ELSE:{})},
//                   2:{#SELECT(NOTA,NULL:{#CHECK("SELECT 1 AS N FROM DUAL",N>0,"Tipo de chamado selecionado, requer que seja informado nota fiscal");},ELSE:{})},
//                   ELSE:{});

DELETE FROM CHAMADOS_CRM WHERE CHAMADO=:WTSSYS_OBJECT;

INSERT INTO CHAMADOS_CRM (
  CHAMADO,
  EVL_SEGUIMENTO
  //PEDIDOV,
  //DADOS_PV_CHAMADO,
  //PEDIDO_NAO_REGISTRADO,
  //PEDIDOV_EXTERNO,
  //NOTA,
  //NOTA_PRESENTE,
  //COD_OPERACAO_NF,
  //TIPO_OPERACAO_NF,
  //PROTOCOLO_RASTREIO,
  //PREFATURAMENTO,
  //TRANSPORTADORA_LOG_REVERSA,
  //TIPO_FRETE_LOG_REVERSA,
  //VALOR_LOG_REVERSA,
  //REQUISICAO_COMPRA,
  //VOLUME_EVENTO,
  //CLIENTE_CONTATADO,
  //TOTAL_DEVOLUCAO_SELECIONADO,
  //TOTAL_DEVOLUCAO_PREENCHIDO,
  //TRANSPORTADORA,
  //TIPO_FRETE,
  //PROTOCOLO_FRETE,
  //V_FRETE,
  //V_FRETE_CALC,
  //DATA_ENTREGA,
  //PRAZOENTREGADIAS,
  //COD_ENDERECO
  )
  VALUES (
  :WTSSYS_OBJECT,
  'A'
  //:PEDIDOV,
  //:DADOS_PV_CHAMADO,
  //:PEDIDO_NAO_REGISTRADO,
  //:PEDIDOV_EXTERNO,
  //:NOTA,
  //:NOTA_PRESENTE,
  //:COD_OPERACAO_NF,
  //:TIPO_OPERACAO_NF
  //:PROTOCOLO_RASTREIO,
  //:PREFATURAMENTO,
  //:TRANSPORTADORA_LOG_REVERSA,
  //:TIPO_FRETE_LOG_REVERSA,
  //:VALOR_LOG_REVERSA,
  //:REQUISICAO_COMPRA,
  //:VOLUME_EVENTO,
  //:CLIENTE_CONTATADO,
  //:TOTAL_DEVOLUCAO_SELECIONADO,
  //:TOTAL_DEVOLUCAO_PREENCHIDO,
  //:TRANSPORTADORA,
  //:TIPO_FRETE,
  //:PROTOCOLO_FRETE,
  //:V_FRETE,
  //:V_FRETE_CALC,
  //:DATA_ENTREGA,
  //:PRAZOENTREGADIAS,
  //:COD_ENDERECO
  );

//DELETE FROM CHAMADO_VALORES_DEVOLUCAO_CRM WHERE CHAMADO=:WTSSYS_OBJECT;

//#EACH() VALORES_DEVOLUCAO;
//INSERT INTO CHAMADO_VALORES_DEVOLUCAO_CRM (
//  CHAMADO,
//  VALOR,
//  FORMA_DEVOLUCAO,
//  TIPO_PGTO,
//  BANCO,
//  AGENCIA,
//  C_C,
//  TRANSACAO_GP
//  )
//VALUES (
//  :WTSSYS_OBJECT,
//  :VALORES_DEVOLUCAO.VALOR,
//  :VALORES_DEVOLUCAO.FORMA_DEVOLUCAO,
//  :VALORES_DEVOLUCAO.TIPO_PGTO,
//  :VALORES_DEVOLUCAO.BANCO,
//  :VALORES_DEVOLUCAO.AGENCIA,
//  :VALORES_DEVOLUCAO.C_C,
//  :VALORES_DEVOLUCAO.TRANSACAO_GP
//)
//#RETURN(CHAMADO_VALOR_DEVOLUCAO_CRM);

#EACH() ITENS_MOVIMENTO AS PRODUTOS
#BEGIN
  #SELECT(PRODUTOS.SELECIONADO,
  True:{
    INSERT INTO CHAMADO_PRODUTOS_CRM (
      CHAMADO,
      PRODUTO,
      COR,
      ESTAMPA,
      TAMANHO,
      LOTE,
      DEFEITO,
      OBSERVACAO,
      PRECO,
      QUANTIDADE,
      VALOR_CORTESIA,
      VALOR_ACERTO,
      VALOR_FRETE,
      EVL_COD_OPERACAO,
      EVL_TIPO_OPERACAO,
      EVL_TOTAL,
      EVL_BASE_ICMS,
      EVL_ICMS,
      EVL_V_ICMS,
      EVL_DATA,
      EVL_NOTA,
      EVL_SIT_TRIB
    )
    VALUES (
    :WTSSYS_OBJECT,
    :PRODUTOS.PRODUTO,
    :PRODUTOS.COR,
    :PRODUTOS.ESTAMPA,
    :PRODUTOS.TAMANHO,
    :PRODUTOS.LOTE,
    :PRODUTOS.DEFEITO,
    :PRODUTOS.OBSERVACAO,
    :PRODUTOS.PRECO,
    :PRODUTOS.EVL_QUANTIDADE,
    :PRODUTOS.VALOR_CORTESIA,
    :PRODUTOS.VALOR_ACERTO,
    :PRODUTOS.VALOR_FRETE,
    :PRODUTOS.COD_OPERACAO,
    :PRODUTOS.TIPO_OPERACAO,
    :PRODUTOS.EVL_TOTAL,
    :PRODUTOS.EVL_BASE_ICMS,
    :PRODUTOS.ICMS,
    :PRODUTOS.EVL_V_ICMS,
    :PRODUTOS.DATA,
    :PRODUTOS.NOTA,
    :PRODUTOS.EVL_SIT_TRIB
  )
  #RETURN(CHAMADO_PRODUTO_CRM)
  }
  ,Else:{});
#END;

//GERA TROCA
#PRIVATE()
SELECT :TROCA_DEVOLUCAO
  CH.PROTOCOLO                                 AS PROTOCOLO
 ,C.CLIENTE                                    AS CLIENTE
 ,TCR.TROCA_DEVOLUCAO                          AS TIPO
 ,MIN(TDP.EVL_TIPO_OPERACAO)                   AS TIPO_OPERACAO
 ,MIN(TDP.EVL_COD_OPERACAO)                    AS COD_OPERACAO
 ,COALESCE(SUM(TDP.QUANTIDADE * TDP.PRECO),0)  AS VALOR_TROCA_DEVOLUCAO
 ,COALESCE(SUM(TDP.VALOR_FRETE),0)             AS VALOR_FRETE
FROM CHAMADO_PRODUTOS_CRM      TDP
  INNER JOIN CHAMADOS          CH  ON CH.CHAMADO = TDP.CHAMADO
  INNER JOIN CLIENTES          C   ON CH.GERADOR = C.GERADOR
  INNER JOIN TIPOS_CHAMADO_CRM TCR ON TCR.TIPO_CHAMADO = CH.TIPO
WHERE TDP.CHAMADO =:WTSSYS_OBJECT
GROUP BY 1,2,3;

INSERT INTO TROCA_DEVOLUCAO(
  PROTOCOLO,
  CLIENTE,
  TIPO,
  VALOR_TROCA_DEVOLUCAO,
  VALOR_FRETE,
  TIPO_OPERACAO
  )
  VALUES (
  :TROCA_DEVOLUCAO.PROTOCOLO,
  :TROCA_DEVOLUCAO.CLIENTE,
  :TROCA_DEVOLUCAO.TIPO,
  :TROCA_DEVOLUCAO.VALOR_TROCA_DEVOLUCAO,
  :TROCA_DEVOLUCAO.VALOR_FRETE,
  :TROCA_DEVOLUCAO.TIPO_OPERACAO
)
#RETURN(TROCA_DEVOLUCAO);


#EACH() ITENS_MOVIMENTO AS PRODUTOS_TROCA_DEVOLUCAO
 #SELECT(PRODUTOS_TROCA_DEVOLUCAO.SELECIONADO,
  TRUE:{
    INSERT INTO CHAMADO_TROCA_DEVOLUCAO_CRM (
      CHAMADO,
      PRODUTO,
      COR,
      ESTAMPA,
      TAMANHO,
      QUANTIDADE,
      PRECO
    )
    VALUES (
      :WTSSYS_OBJECT,
      :PRODUTOS_TROCA_DEVOLUCAO.PRODUTO,
      :PRODUTOS_TROCA_DEVOLUCAO.COR,
      :PRODUTOS_TROCA_DEVOLUCAO.ESTAMPA,
      :PRODUTOS_TROCA_DEVOLUCAO.TAMANHO,
      :PRODUTOS_TROCA_DEVOLUCAO.EVL_QUANTIDADE,
      :PRODUTOS_TROCA_DEVOLUCAO.PRECO)
    #RETURN(CHAMADO_TROCA_DEVOLUCAO_CRM)
    }
  ,ELSE:{});


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>