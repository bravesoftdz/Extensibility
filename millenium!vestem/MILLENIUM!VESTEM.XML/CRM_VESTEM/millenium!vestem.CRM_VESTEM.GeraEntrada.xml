<?xml version="1.0"?>
<root>
  <OBJECT NAME="CRM_VESTEM">
    <METHOD NAME="GeraEntrada" DESCRIPTION="" VERSION="182" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="CHAMADO" FORMAT="N" SIZE="8" FLAGS="1" DEFAULT="667" PROJECTION="0" ORDER="1" FIELDLABEL="Cod Operacao" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#CALL:EVL_ROMANEIO MILLENIUM.UTILS.DEFAULT(NOME="ROMANEIO", TAMANHO=9);

#PRIVATE()
SELECT:ORIGEM
     F.FILIAL                        AS FILIAL
    ,1000001                         AS CONTA
    ,F.CENTRO_CUSTOS                 AS CENTRO_CUSTOS
    ,C.CLIENTE                       AS CLIENTE
    ,TD.TROCA_DEVOLUCAO              AS TROCA_DEVOLUCAO
    ,(SELECT
      SUM(PC.QUANTIDADE)
      FROM CHAMADO_PRODUTOS_CRM PC
      WHERE PC.CHAMADO = X.CHAMADO)  AS QTDE
    ,(SELECT
      SUM(PC2.QUANTIDADE*PC2.PRECO)
      FROM CHAMADO_PRODUTOS_CRM PC2
      WHERE PC2.CHAMADO = X.CHAMADO) AS TOTAL
    ,(SELECT
      FIRST 1 EV.EVL_EVENTO_DEV
      FROM CHAMADO_PRODUTOS_CRM CCR
        INNER JOIN SAIDAS S ON S.SAIDA = CCR.EVL_COD_OPERACAO
        INNER JOIN EVENTOS EV ON EV.EVENTO = S.EVENTO
      WHERE CCR.CHAMADO = X.CHAMADO) AS EVENTO
    ,(SELECT
      FIRST 1 S.MODALIDADE_FRETE
      FROM CHAMADO_PRODUTOS_CRM CCR
        INNER JOIN SAIDAS S ON S.SAIDA = CCR.EVL_COD_OPERACAO
      WHERE CCR.CHAMADO = X.CHAMADO) AS MODALIDADE_FRETE
FROM CHAMADOS X
  INNER JOIN CLIENTES C ON C.GERADOR = X.GERADOR
  INNER JOIN FILIAIS F ON F.FILIAL = X.FILIAL
  INNER JOIN TROCA_DEVOLUCAO TD ON TD.PROTOCOLO = X.PROTOCOLO
WHERE X.CHAMADO = :CHAMADO;


//Consulta os produtos
#PRIVATE()
SELECT:PRODUTOS
   PRODUTO           AS PRODUTO
  ,COR               AS COR
  ,ESTAMPA           AS ESTAMPA
  ,TAMANHO           AS TAMANHO
  ,PRECO             AS PRECO
  ,PRECO             AS PRECO_BRUTO
  ,PRECO             AS PRECO_TOTAL
  ,QUANTIDADE        AS QUANTIDADE
  ,EVL_DATA          AS NOTA_REF
  ,EVL_SIT_TRIB      AS SIT_TRIB
  ,EVL_COD_OPERACAO  AS COD_OPERACAO_REF
  ,EVL_TIPO_OPERACAO AS TIPO_OPERACAO_REF
  ,EVL_BASE_ICMS     AS BICM
  ,EVL_ICMS          AS ICMS
  ,EVL_V_ICMS        AS V_ICMS
FROM CHAMADO_PRODUTOS_CRM
WHERE CHAMADO =:CHAMADO;

SELECT:LANCAMENTOS_DEV
     F.FILIAL          AS FILIAL
    ,F.CONTA           AS CONTA
    ,4                 AS TIPO_PGTO
    ,#DATE()           AS DATA_EMISSAO
    ,#DATE()           AS DATA_VENCIMENTO
    ,'T'               AS TITULO
    ,0                 AS PERCENTUAL_JUROS
    //,#REPLACE(:EVL_ROMANEIO.RESULT) AS DOCUMENTO
    ,(SELECT SUM(PC2.QUANTIDADE*PC2.PRECO) FROM CHAMADO_PRODUTOS_CRM PC2 WHERE PC2.CHAMADO = X.CHAMADO) AS VALOR_INICIAL
    ,(SELECT SUM(PC2.QUANTIDADE*PC2.PRECO) FROM CHAMADO_PRODUTOS_CRM PC2 WHERE PC2.CHAMADO = X.CHAMADO) AS VALOR_JUROS
    ,(SELECT SUM(PC2.QUANTIDADE*PC2.PRECO) FROM CHAMADO_PRODUTOS_CRM PC2 WHERE PC2.CHAMADO = X.CHAMADO) AS VALOR_CALCULADO
FROM CHAMADOS X
  INNER JOIN CLIENTES C ON C.GERADOR = X.GERADOR
  INNER JOIN FILIAIS F ON F.FILIAL = X.FILIAL
  INNER JOIN TROCA_DEVOLUCAO TD ON TD.PROTOCOLO = X.PROTOCOLO
WHERE X.CHAMADO =:CHAMADO;

#CALL:MOVIMENTACAO_ENTRADA MILLENIUM.MOVIMENTACAO.EXECUTA(
   TROCA_DEVOLUCAO         =214700007
  ,EVENTO                  = 22  //DEFINIR NOVO EVENTO
  ,CONDICOES_PGTO          = 9
  ,FILIAL                   =:ORIGEM.FILIAL
  ,CONTA                    =:ORIGEM.CONTA
  ,ROMANEIO                =:EVL_ROMANEIO.RESULT
  ,DATA                    =#DATE()
  ,DATA_ATUALIZACAO        =#NOW()
  ,TOTAL                   =:ORIGEM.TOTAL
  ,QTDE                    =:ORIGEM.QTDE
  ,VALOR_FINAL             =:ORIGEM.TOTAL
  ,CLIENTE                 =:ORIGEM.CLIENTE
  ,PRODUTOS                =:PRODUTOS
//  ,LANCAMENTOS             =:LANCAMENTOS_FRANQUIA
//  ,NOTAS                   =:NOTA_FRANQUIA
  ,MODALIDADE_FRETE        =0
//  ,NUMERACAO_NOTA_AUTO     =FALSE
);


</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>