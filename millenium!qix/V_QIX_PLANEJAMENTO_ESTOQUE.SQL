CREATE OR ALTER VIEW V_QIX_PLANEJAMENTO_ESTOQUE(
    PLANEJAMENTO_ESTOQUE,
    PRODUTO,
    COR,
    ESTAMPA,
    TAMANHO,
    QTD_PROP_GRADE,
    PERIODO,
    QTD_VENDA_PROD,
    QTD_VENDA,
    QTD_ESTOQUE,
    QTD_PRODUZIDO,
    QTD_SALDO)
AS
SELECT PEP.PLANEJAMENTO_ESTOQUE,
       PEP.PRODUTO,
       PEP.COR,
       PEP.ESTAMPA,
       PEP.TAMANHO,
       PEP.QTD_PROP_GRADE,
       PEV.PERIODO,
       PEV.QTD_VENDA_PROD,
       ROUND(PEV.QTD_VENDA_PROD * (PEP.QTD_PROP_GRADE/100),0) AS QTD_VENDA,
       PEE.QTD_ESTOQUE,
       PER.QTD_PRODUZIDO,
       (COALESCE(ROUND(PEV.QTD_VENDA_PROD * (PEP.QTD_PROP_GRADE/100),0),0)+COALESCE(PEE.QTD_ESTOQUE,0)-COALESCE(PER.QTD_PRODUZIDO,0)) AS QTD_SALDO
FROM QIX_PLAN_ESTOQUE_PRODUTOS PEP
LEFT JOIN (SELECT PLANEJAMENTO_ESTOQUE,
                  PRODUTO,
                  PERIODO,
                  SUM(QTD_VENDA) AS QTD_VENDA_PROD
           FROM QIX_PLAN_ESTOQUE_VENDAS
           GROUP BY PLANEJAMENTO_ESTOQUE,PRODUTO,PERIODO) PEV ON (PEV.PLANEJAMENTO_ESTOQUE = PEP.PLANEJAMENTO_ESTOQUE) AND
                                                                 (PEV.PRODUTO = PEP.PRODUTO)
LEFT JOIN QIX_PLAN_ESTOQUE_ESTOQUES PEE ON (PEE.PLANEJAMENTO_ESTOQUE = PEP.PLANEJAMENTO_ESTOQUE) AND
                                           (PEE.PRODUTO = PEP.PRODUTO) AND
                                           (PEE.COR = PEP.COR) AND
                                           (PEE.ESTAMPA = PEP.ESTAMPA) AND
                                           (PEE.TAMANHO = PEP.TAMANHO)
LEFT JOIN QIX_PLAN_ESTOQUE_PRODUZIDOS PER ON (PER.PLANEJAMENTO_ESTOQUE = PEP.PLANEJAMENTO_ESTOQUE) AND
                                           (PER.PRODUTO = PEP.PRODUTO) AND
                                           (PER.COR = PEP.COR) AND
                                           (PER.ESTAMPA = PEP.ESTAMPA) AND
                                           (PER.TAMANHO = PEP.TAMANHO)