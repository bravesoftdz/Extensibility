<?xml version="1.0"?>
<root>
  <OBJECT NAME="PLANEJAMENTOS_ESTOQUES">
    <METHOD NAME="CriarItensPlanejamento" DESCRIPTION="" VERSION="27" INTFTYPE="17" THREADSAFE="1">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="PLANEJAMENTO_ESTOQUE" FORMAT="N" SIZE="8" PROJECTION="0" FIELDLABEL="Planejamento Estoque" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>DELETE FROM QIX_PLAN_ESTOQUE_PRODUTOS WHERE PLANEJAMENTO_ESTOQUE=:PLANEJAMENTO_ESTOQUE;
DELETE FROM QIX_PLAN_ESTOQUE_VENDAS WHERE PLANEJAMENTO_ESTOQUE=:PLANEJAMENTO_ESTOQUE;

UPDATE QIX_PLAN_ESTOQUES SET DATA_PROCESSAMENTO=#NOW(),USUARIO_PROCESSAMENTO=#USER() WHERE PLANEJAMENTO_ESTOQUE=:PLANEJAMENTO_ESTOQUE;

#SET(TBL, ${#CREATETABLE(PRODUTO INTEGER,
                         COR INTEGER,
                         ESTAMPA INTEGER,
                         TAMANHO VARCHAR(5),
                         QTD_PROP_GRADE INTEGER)});
CREATE INDEX #REPLACE(TBL)_1 ON #REPLACE(TBL) (PRODUTO,COR,ESTAMPA,TAMANHO);

#EACH() SELECT:PRODS
               P.PRODUTO,
               CP.COR,
               EP.ESTAMPA,
               TP.TAMANHO,
               #NULL_TO_Z(QT.PERC_DIST) AS QTD_PROP_GRADE
        FROM PRODUTOS P
        INNER JOIN COR_PROD CP ON (CP.PRODUTO = P.PRODUTO)
        INNER JOIN ESTAMPA_PROD EP ON (EP.PRODUTO = P.PRODUTO)
        INNER JOIN TAM_PROD TP ON (TP.PRODUTO = P.PRODUTO)
        INNER JOIN QIX_PAN_ESTOQUE_FILTROS FGR ON (FGR.PLANEJAMENTO_ESTOQUE = :PLANEJAMENTO_ESTOQUE) AND
                                                  (FGR.TIPO = 2) AND
                                                  (FGR.VALOR = P.GRADE)
        LEFT JOIN QIX_TAMANHOS QT ON (QT.GRADE = P.GRADE) AND
                                     (QT.TAMANHO = TP.TAMANHO)
        ORDER BY P.PRODUTO,CP.COR,EP.ESTAMPA,TP.TAMANHO;
            INSERT INTO #REPLACE(TBL) (PRODUTO,COR,ESTAMPA,TAMANHO,QTD_PROP_GRADE)
                               VALUES (:PRODS.PRODUTO,:PRODS.COR,:PRODS.ESTAMPA,:PRODS.TAMANHO,:PRODS.QTD_PROP_GRADE);
                                       
#EACH() SELECT:VENDAS
               PE.PRODUTO,
               PE.COR,
               PE.ESTAMPA,
               PE.TAMANHO,
               PER.VALOR AS PERIODO,
               SUM(PE.QUANTIDADE) AS QTD_VENDA
        FROM SAIDAS S
        INNER JOIN PRODUTOS_EVENTOS PE ON (PE.TIPO_OPERACAO = 'S') AND
                                          (PE.COD_OPERACAO = S.SAIDA)
        INNER JOIN #REPLACE(TBL) PROD ON (PROD.PRODUTO = PE.PRODUTO) AND
                                         (PROD.COR = PE.COR) AND
                                         (PROD.ESTAMPA = PE.ESTAMPA) AND
                                         (PROD.TAMANHO = PE.TAMANHO)
        INNER JOIN QIX_PAN_ESTOQUE_FILTROS PER ON (PER.PLANEJAMENTO_ESTOQUE = :PLANEJAMENTO_ESTOQUE) AND
                                                  (PER.TIPO = 0)
        INNER JOIN QIX_PAN_ESTOQUE_FILTROS FIL ON (FIL.PLANEJAMENTO_ESTOQUE = :PLANEJAMENTO_ESTOQUE) AND
                                                  (FIL.TIPO = 1) AND
                                                  (FIL.VALOR = S.FILIAL)
        WHERE (S.CANCELADA &lt;> 'T') AND
              (DATEDIFF(DAY,S.DATA,CAST('NOW' AS TIMESTAMP)) &lt;= PER.VALOR) AND
        GROUP BY PE.PRODUTO,PE.COR,PE.ESTAMPA,PE.TAMANHO,PER.VALOR
        ORDER BY PE.PRODUTO,PE.COR,PE.ESTAMPA,PE.TAMANHO;
            INSERT INTO QIX_PLAN_ESTOQUE_VENDAS (PLANEJAMENTO_ESTOQUE,PRODUTO,COR,ESTAMPA,TAMANHO,PERIODO,QTD_VENDA)
                                         VALUES (:PLANEJAMENTO_ESTOQUE,:VENDAS.PRODUTO,:VENDAS.COR,:VENDAS.ESTAMPA,:VENDAS.TAMANHO,:VENDAS.PERIODO,:VENDAS.QTD_VENDA)
                                         #RETURN(PLAN_ESTOQUE_VENDA);
                                         
                                         
#EACH() SELECT:ESTOQUES
               PROD.PRODUTO,
               PROD.COR,
               PROD.ESTAMPA,
               PROD.TAMANHO,
               MIN(PROD.QTD_PROP_GRADE) AS QTD_PROP_GRADE,
               #NULL_TO_Z(SUM(E.SALDO)) AS QTD_ESTOQUE
        FROM #REPLACE(TBL) PROD
        LEFT JOIN ESTOQUES E ON (PROD.PRODUTO = E.PRODUTO) AND
                                (PROD.COR = E.COR) AND
                                (PROD.ESTAMPA = E.ESTAMPA) AND
                                (PROD.TAMANHO = E.TAMANHO)
        LEFT JOIN QIX_PAN_ESTOQUE_FILTROS FIL ON (FIL.PLANEJAMENTO_ESTOQUE = :PLANEJAMENTO_ESTOQUE) AND
                                                 (FIL.TIPO = 1) AND
                                                 (FIL.VALOR = E.FILIAL)
        GROUP BY PROD.PRODUTO,PROD.COR,PROD.ESTAMPA,PROD.TAMANHO
        ORDER BY PROD.PRODUTO,PROD.COR,PROD.ESTAMPA,PROD.TAMANHO;
            INSERT INTO QIX_PLAN_ESTOQUE_PRODUTOS (PLANEJAMENTO_ESTOQUE,PRODUTO,COR,ESTAMPA,TAMANHO,QTD_PROP_GRADE,QTD_ESTOQUE,QTD_VENDA,QTD_PRODUZIDO)
                                   VALUES (:PLANEJAMENTO_ESTOQUE,:ESTOQUES.PRODUTO,:ESTOQUES.COR,:ESTOQUES.ESTAMPA,:ESTOQUES.TAMANHO,:ESTOQUES.QTD_PROP_GRADE,:ESTOQUES.QTD_ESTOQUE,0,0)
                                   #RETURN(PLAN_ESTOQUE_PRODUTO);






</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>